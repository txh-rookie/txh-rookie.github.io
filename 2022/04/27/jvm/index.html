<!DOCTYPE HTML>
<html lang="zh">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="jvm, kevintam">
    <meta name="description" content="1、jvm的体系结构
2、什么是类加载器作用:类加载器用于加载类对象的。
类加载器的分类:根加载器、扩展加载器、应用加载器。

3、双亲委派机制 一个类加载器查找class和resource时，是通过“委托模式”进行的，它首先判断这个cla">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>jvm | kevintam</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">kevintam</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">kevintam</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/txh-rookie" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>txh-rookie
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/txh-rookie" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="txh-rookie" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">jvm</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/jvm/">
                                <span class="chip bg-color">jvm</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">
                                技术
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-04-27
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1、jvm的体系结构"><a href="#1、jvm的体系结构" class="headerlink" title="1、jvm的体系结构"></a>1、jvm的体系结构</h2><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220220161522429.png" alt="image-20220220161522429"></p>
<h2 id="2、什么是类加载器"><a href="#2、什么是类加载器" class="headerlink" title="2、什么是类加载器"></a>2、什么是类加载器</h2><p>作用:类加载器用于加载类对象的。</p>
<p>类加载器的分类:根加载器、扩展加载器、应用加载器。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220328204134383.png" alt="image-20220328204134383"></p>
<h2 id="3、双亲委派机制"><a href="#3、双亲委派机制" class="headerlink" title="3、双亲委派机制"></a>3、双亲委派机制</h2><p> 一个类加载器查找class和resource时，是通过“委托模式”进行的，它首先判断这个class是不是已经加载成功，如果没有的话它并不是自己进行查找，而是先通过父加载器，然后递归下去，直到Bootstrap ClassLoader，如果Bootstrap classloader找到了，直接返回，如果没有找到，则一级一级返回，最后到达自身去查找这些对象。这种机制就叫做双亲委托。</p>
<p>顺序:发现委托是从下向上,然后具体查找过程却是自上至下。</p>
<p>作用:</p>
<p>1、避免重复加载,当父类加载的时候,子类的classloader就没必要在加载一次.</p>
<p>2、安全因素，如果不使用这样的委托模式,那么用户可以随时自定义的String来动态替代java的核心类.这样存在非常大的隐患。原因：因为String的类在JVM启动的时候,就已经被父类的加载器进行加载了,用户自定义的类就无法加载进去了。</p>
<h2 id="4、Native-本地方法栈"><a href="#4、Native-本地方法栈" class="headerlink" title="4、Native(本地方法栈)"></a>4、Native(本地方法栈)</h2><p>什么是native:java的关键字,凡事带了native关键字的表示说明java的作用域范围达不到了，会去调用底层c或者c++的本地库。</p>
<p>会进入到本地方法栈。调用本地方法接口JNI</p>
<p>JNI的作用:扩展java的使用，使其能够融合不同的编程语言为java所用。</p>
<p>执行顺序:</p>
<p>它会在内存中专门开辟一块标志区域:native method stack，登记native方法,在最终执行的时候，加载本地方法库中的方法</p>
<h2 id="5、程序技术器"><a href="#5、程序技术器" class="headerlink" title="5、程序技术器"></a>5、程序技术器</h2><p>1、程序计数器是一块较小的区域,可以看作是当前线程执行的字节码的行号指示器。</p>
<p>2、作用:程序控制流的指示器，分支、循环、跳转、异常处理、线程恢复等基础功能。</p>
<p>3、程序计数器是线程私有?</p>
<ul>
<li>因为java的多线程通过轮流切换、分配处理器执行时间来实现的。在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。因此为了线程切换后能恢复到正确的执行位置。</li>
</ul>
<p>4、如果线程正在执行的是一个java方法，那么这个计数器记录的是正在执行的是字节码指令的地址，如果是本地方法，那么这个计数器则为null。</p>
<p>5、程序计数器是唯一一个没有规定任何OutOfMemoryError情况的区域.</p>
<h2 id="6、方法区"><a href="#6、方法区" class="headerlink" title="6、方法区"></a>6、方法区</h2><p>Method area方法区</p>
<p>方法区和堆一样,是各个线程共享的内存区域,它用于存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等数据。</p>
<p>方法区是规范,像什么永久代(jdk1.6 占用的堆内存)和元空间(jdk 1.8 占用的是系统内存)只是实现。</p>
<p>如果方法区无法满足新的内存分配需求时，将抛出OutOfMemoryError异常。</p>
<p>jdk1.6的方法区内存结构:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220726163247742.png" alt="image-20220726163247742"></p>
<p>Jdk 1.6组成：</p>
<p>类信息、类加载器、运行时常量池（字符常量池）</p>
<p>Jdk 1.8的组成:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220726164138565.png" alt="image-20220726164138565"></p>
<p>在jdk1.8之后，将永久带进行了废弃,使用元空间来实现方法区。将元空间放到了直接内存(本地内存)中。</p>
<p>还有一个区别就是,将SpringTable，从元空间中抽取出来放到了heap堆内存中。</p>
<p>元空间的调控参数：</p>
<p>-XX:MaxMetaspaceSize&#x3D;8m</p>
<p>字节码:cglib在运行期间动态生成类字节码,完成动态的类加载</p>
<p>方法区的重要组成部分:运行时常量池</p>
<ul>
<li>常量池,就是一张表,虚拟机指令根据这张常量表找到执行的类名、方法名、参数类型、字面量等信息。</li>
<li>运行时常量池，常量池是*.class文件中的，当该类被加载,它的常量池信息就会放入运行时常量池,并把里面的符号地址变为真实地址。</li>
</ul>
<p>StringTable的特性:</p>
<ul>
<li>常量池中的字符串仅是符号,第一次用到时才变为对象</li>
<li>利用串池的机制,来避免重复创建字符串对象</li>
<li>字符串变量拼接的原理是StringBuilder(1.8)</li>
<li>字符串常量拼接的原理是编译期优化</li>
<li>可以使用intern方法，主动将串池中还没有的字符串对象放入串池。如果串池中有,则直接返回串池中的对象，如果串池中没有,就将改对象放入到串池中。</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//常量池和串池之间的关系</span>
<span class="token comment" spellcheck="true">//常量池中的信息,都会被加载到运行时常量池中。</span>
<span class="token comment" spellcheck="true">//创建一个StringTable也就是字符串常量池.将字面值放入到StringTable中。先去查找一下是否存在改数据，如果存在，那么就不会放进行，如果没有就将字面值放进去。</span>
<span class="token comment" spellcheck="true">//StringTable Hashtable,不能扩容</span>
String s1<span class="token operator">=</span><span class="token string">"a"</span><span class="token punctuation">;</span>
String s2<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">;</span>
String s3<span class="token operator">=</span><span class="token string">"ab"</span><span class="token punctuation">;</span>
String s4<span class="token operator">=</span>s1<span class="token operator">+</span>s2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//底层 new StringBuilder()调用append方法来进行拼接操作。调用toString()将其转为String对象</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3<span class="token operator">==</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>在jdk1.6 StringTable也就是字符串常量池是存储在永久带中的。而jdk1.8以后，移除了永久带,使用元空间来进行代替.将字符串常量池从方法区里移出，放到了堆内存中。</li>
<li>springtable是可以被垃圾回收的<ul>
<li>参数:-Xmx:10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</li>
</ul>
</li>
<li>springtable的性能调优<ul>
<li>调整-XX:StringTableSize&#x3D;桶的大小</li>
<li>可以将字符串放入到常量池中。</li>
</ul>
</li>
</ul>
<h2 id="7、队列和栈"><a href="#7、队列和栈" class="headerlink" title="7、队列和栈"></a>7、队列和栈</h2><p>队列（FIFO）：先进先出</p>
<p>栈:先进后出</p>
<p>生命周期：虚拟机栈道生命周期与线程相同的</p>
<p>栈也是线程私有的。</p>
<p>栈:8大基本类型+对象引用+实例方法</p>
<p>栈运行原理:栈帧</p>
<p>什么时候执行:</p>
<blockquote>
<p>每个方法执行的时候，java虚拟机都会同步创建一个栈帧。每一个方法被调用直至执行完毕的过程，就对应一个栈帧在虚拟机中从入栈到出栈道过程。</p>
</blockquote>
<p>栈满了:StackOverflowError</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220726134034510.png" alt="image-20220726134034510"></p>
<p>栈的定义:</p>
<ul>
<li>每个线程运行时所需要的内存,称为虚拟机栈</li>
<li>每个栈由多个栈帧组成,对应着每次方法调用时所占用的内存</li>
<li>每个线程只能有一个活动栈帧,对应着当前正在执行的那个方法 ,存在于栈帧的顶部</li>
<li>栈帧指每个方法运行时所需要的内存空间,有参数、局部变量、返回地址等</li>
</ul>
<p>栈帧用来存储什么?</p>
<p>1、用于存储局部变量表、操作数栈、动态连接、方法出口等</p>
<ul>
<li>局部变量存放着各种java虚拟机的基本数据类型（byte、short、int、long、float、double、boolean、char）和对象引用(它不等同于对象本身，可以只是一个只想对象起始地址的引用地址)和returnAddress(存储的是return后要执行的字节码的指令地址)类型</li>
</ul>
<p><font color="red"><strong>在java虚拟机中规范队这个内存区域规范了两类异常状况:1、如果线程请求的栈深度大于虚拟机所允许的深度，将会抛出StackOverflowError异常。2、如果java虚拟机栈容量可以动态扩展当栈扩展时无法申请到足够的内存会抛出OutOfMemoryError异常</strong></font></p>
<p><font color="red">问题分析:</font></p>
<ul>
<li>垃圾回收是否涉及到栈内存？</li>
</ul>
<p>不会，因为方法执行结束后,栈空间的内存的栈帧就会被进行弹栈处理,栈空间会自动释放.</p>
<ul>
<li>栈内存分配是否越大越好?</li>
</ul>
<p>栈的内存可以通过参数进行调整,通过-Xss size。栈内存分配不是越大越好,因为物理内存是固定的，比如说有500M，栈内存为1m，那么在理论上就可以创建500个线程。如果栈内存变为了2m，那么我们的线程就会减少至250个。栈内存的分配越大，就会导致我们的线程数就越少。</p>
<ul>
<li>方法内的局部变量是否是线程安全的</li>
</ul>
<p>线程安全问题在于是否共享，如果共享就要考虑线程安全问题，线程私有不需要考虑线程安全问题的。</p>
<p>方法内的局部变量是否逃离了方法的作用域,如果逃离了，那么就需要考虑线程安全问题。如果没有逃离就不需要考虑线程安全的问题。</p>
<p>栈内存溢出:</p>
<ul>
<li>栈帧过多导致栈内存溢出（递归）</li>
<li>栈帧过大导致内存溢出</li>
</ul>
<p><font color="red">调控参数:</font></p>
<ul>
<li>可以使用-Xss256k，来调控栈内容大小</li>
</ul>
<p><font color="orange">线程的诊断案列：</font></p>
<p>1、CPU占用过多</p>
<blockquote>
<p>1、可以使用top去定位一下后台的是那个进程的cpu占用过高</p>
<p>2、通过ps和grep可以准确找到那个进程里面那个线程占用过高</p>
<p>3、通过jstack 进程id,会将某一个进程中的所有的java线程都会展示出来</p>
<ul>
<li>可以根据线程id找到有问题的线程,进一步定位到问题代码的源码行号</li>
</ul>
</blockquote>
<p>2、程序运行很长时间没有结果</p>
<p>还是使用jstack 进程id，查看一下那端代码出现问题，进行解决.</p>
<h2 id="7、Heap-堆"><a href="#7、Heap-堆" class="headerlink" title="7、Heap 堆"></a>7、Heap 堆</h2><p>通过new关键字,创建对象都会使用堆内存</p>
<p>特点：它是被所有线程共享的一块内存区域,堆中对象都需要考虑线程安全问题，存在垃圾回收机制。</p>
<p>目的:   存放对象实例。</p>
<p>堆内存溢出:OutOfMemoryError</p>
<p>出现的原因: java堆中没有内存完成实例分配，并且堆也无法在扩展时，java虚拟机将会抛出OutOfMemoryError异常。</p>
<p>堆空间的调参:  -Xmx8m -Xms</p>
<p>堆内存的诊断:</p>
<ul>
<li>jps,拿到系统中有哪些java进程</li>
<li>jmap工具<ul>
<li>jmap -heap 进程id</li>
<li>查看堆内存中占用情况,只能查看某一时刻</li>
</ul>
</li>
<li>jconsole工具<ul>
<li>提供了图形可视化窗口,多功能连续监视</li>
</ul>
</li>
<li>JvisualVm工具<ul>
<li>也是一个图形可视化的窗口,只不过提供了更加强大的功能</li>
</ul>
</li>
</ul>
<h3 id="对象的创建"><a href="#对象的创建" class="headerlink" title="对象的创建"></a>对象的创建</h3><p>对象的创建通过new关键字，但是从jvm的层面来说对象的创建过程又是什么样的呢?</p>
<p>当java虚拟机遇到一条字节码new指令时,首先将去检查这个指令的参数是否能在常量池中定位到一个类的符号引用,并且检查这个符号引用代表的类是否已被加载、解析和初始化过。如果没有，那必须先执行相应的类加载过程。在类加载检查通过后,接下来虚拟机将为新生对象分配内存。对象所需内存的大小在类加载完成后便可完全确定，为对象分配空间的任务实际上便等于把一块确定大小的内存块从java堆中划分出来，根据java堆中的内存是否规整来选择那种分配方式。而java堆是否规整又由所采用的垃圾收集器是否带有空间压缩整理的能力决定的。因此，当使用serial、ParNew等代压缩整理过程代收集器时,采用指针碰撞的方式来分配内存，即简单有高效。而当使用cms这种基于清除算法的收集器时,理论上就只能采用较为复杂的空闲列表来分配内存。</p>
<p>对象创建在虚拟机中时非常频繁的行为,即使仅仅修改一个指针所指向的位置，在并发的情况下也并不是线程安全的,可能出现正在给对象A分配内存，指针还没来得及修改，对象B又同时使用了原来的指针来分配内存的情况。解决这个问题有两种解决方案:1、采用同步处理–虚拟机采用CAS配上失败重试的方式保证更新操作的原子性；另外一种是把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在java堆中预先分配一小块内存(线程隔离),称谓本地线程分配缓存(TLAB)，那个线程要分配内存,就在那个线程的本地缓冲区中分配,只有本地缓冲区用完了,分配新的缓存区时才需要同步锁定。虚拟机是否使用TLAB,可以通过-XX:+&#x2F;-UseTLAB参数来设定。</p>
<p>对象在内存分配空间之后，虚拟机必须将分配到的内存空间懂初始化为零值,如果使用了TLAB的话，这一项工作可以提前至TLAB中进行完成。接下来，java虚拟机还要对对象进行必要的设置，例如这个对象时那个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的GC分代年龄等信息。这些信息存放在对象的对象头之中。根据虚拟机当前运行状态的不同,如是否启用偏向锁等。从虚拟机的角度来看一个新的对象已经产生了。</p>
<p>两种分配内存的方式:</p>
<p>1、假设java堆中内存时绝对规整的，所有被使用过的内存都被放在一边，空闲的内存被放在另一边,中间放着一个指针作为分界点的指示器,那所分配内存仅仅是把那个指针向空闲空间方法挪动一段与对象大小相等的距离，这种分配方法称为”指针碰撞”。</p>
<p>2、假设java堆中的内存不是绝对规整的,已被使用和空闲的内存相互交错在一起,那就没有办法简单的通过指针碰撞的方法来分配内存了。虚拟机就必要维护一个列表,记录哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例,并更新列表上的记录，这种分配方式称为空闲列表。</p>
<p>对象内存布局:</p>
<p>对象在堆内存中的存储布局可以划分为三部分：对象头(Header)、实例数据和对齐填充。</p>
<p>对象头包含两类信息:</p>
<ul>
<li>用于存储对象自身的运行时数据,如哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向线程id、偏向时间戳等。(Mark world)</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220729225606753.png" alt="image-20220729225606753"></p>
<ul>
<li>类型指针,即对象指向它的类型元数据等指针,java虚拟机通过这个指针来确定改对象是那个类的实例。</li>
</ul>
<p>实例数据存储的是对象真正存储的有效信息，即我们在程序代码里面所定义的各种类型的字段内容，无论是从父类继承下来的，还是在子类中定义的字段懂必须记录起来。</p>
<p>对齐填充,这并不是必然存在的，也没有特别的含义，就是起到了占位符的作用。对象头地址必须是8的整数倍，如果对象实例部分没有对齐，就通过对齐填充来补全为8字节的倍数。</p>
<h3 id="对象的访问定位"><a href="#对象的访问定位" class="headerlink" title="对象的访问定位"></a>对象的访问定位</h3><p>主流的虚拟机对象访问方式有两种方式</p>
<ul>
<li><p>句柄</p>
<ul>
<li>如果使用句柄访问的话，java堆中将可能会划分出一块内存来作为句柄池,reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自具体的地址信息。</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220729230633077.png" alt="image-20220729230633077"></p>
</li>
<li><p>直接指针</p>
<ul>
<li>如果使用直接指针访问的话，java堆中对象的内存布局就必须考虑如何放置访问类型数据的相关信息，reference中存储的直接就是对象地址，如果只是访问对象本身的话，就不需要多一次间接访问的开销。</li>
</ul>
</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220729230837541.png" alt="image-20220729230837541"></p>
<p>使用句柄的好处就是:reference中存储的是稳定句柄地址，在对象被移动时只会改变句柄中的实例数据指针，而reference本身不需要被修改。</p>
<p>使用直接指针来访问最大的好处就是访问速度更快。</p>
<h2 id="8、直接内存"><a href="#8、直接内存" class="headerlink" title="8、直接内存"></a>8、直接内存</h2><p>直接内存也叫做系统内存,一般是用于io操作的。用于数据缓存区</p>
<p>分配回收成本较高,但读写性能高</p>
<p>不受jvm内存回收管理</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727110606394.png" alt="image-20220727110606394"></p>
<p>从磁盘文件读取数据到系统缓存区，但是因为java代码无法直接系统内存,所以需要将系统内存中的数据，在拿到java堆内存中的缓冲区，到了这里java代码就可以直接操作了。但是这样会出现了重复,因为系统内存有一份，java的堆内存又有一份。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727112654053.png" alt="image-20220727112654053"></p>
<p>开辟一块直接内存,这样不管是系统内存还是java内存都可以直接使用。在java中要使用unsafe类开管理内存,但unsafe类不能通过new关键字来进行获取，要通过反射去拿。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>kevintam<span class="token punctuation">.</span>stock<span class="token punctuation">;</span>

<span class="token keyword">import</span> sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Unsafe<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author kevintam
 * @version 1.0
 * @title
 * @description
 * @createDate 2022/7/27
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsafeDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchFieldException<span class="token punctuation">,</span> IllegalAccessException <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//        Unsafe unsafe = Unsafe.getUnsafe();</span>
<span class="token comment" spellcheck="true">//        System.out.println(unsafe);</span>
        Field theUnsafe <span class="token operator">=</span> Unsafe<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"theUnsafe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//设置是否开启</span>
        theUnsafe<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Unsafe unsafe <span class="token operator">=</span> <span class="token punctuation">(</span>Unsafe<span class="token punctuation">)</span>theUnsafe<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        unsafe.compareAndSwap</span>
<span class="token comment" spellcheck="true">//        unsafe.</span>
        <span class="token comment" spellcheck="true">//分配空间</span>
<span class="token comment" spellcheck="true">//        unsafe.allocateMemory()</span>
        <span class="token comment" spellcheck="true">//释放内存</span>
<span class="token comment" spellcheck="true">//        unsafe.freeMemory();</span>
<span class="token comment" spellcheck="true">//        System.out.println(unsafes);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>分配和回收原理:</p>
<ul>
<li>使用Unsafe对象完成直接内存的分配回收,并且回收需要主动调用freeMemory</li>
<li>ByteBuffer的实现类内部,使用了Clear(虚引用)来监视ByteBuffer对象，一旦ByteBuffer对象被垃圾回收，那么就会由ReferenceHandler线程通过Clear的clear方法调用freeMemory来释放直接内存。</li>
</ul>
<h2 id="9、垃圾回收"><a href="#9、垃圾回收" class="headerlink" title="9、垃圾回收"></a>9、垃圾回收</h2><h3 id="1、如何判断对象可以回收"><a href="#1、如何判断对象可以回收" class="headerlink" title="1、如何判断对象可以回收"></a>1、如何判断对象可以回收</h3><h4 id="1-1引用计数法"><a href="#1-1引用计数法" class="headerlink" title="1.1引用计数法"></a>1.1引用计数法</h4><p> 指：只要有一个对象被其他对象所引用，就会让这个对象的计数器加1，没有引用就会减一，直到这个计数会0，即可回收改对象</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727130137448.png" alt="image-20220727130137448"></p>
<p>缺点:就是如果两个对象互相引用，就会导致这个对象的引用计数永远不会为0，那么就不会被进行回收.</p>
<h4 id="1、2-可达性分析算法"><a href="#1、2-可达性分析算法" class="headerlink" title="1、2 可达性分析算法"></a>1、2 可达性分析算法</h4><p>可达性分析算法首先要确定一系列根对象(不会被当做垃圾回收的对象，就叫做根对象)。如果一个对象有被这个根对象直接或者间接引用的对象，就不能被回收。如果没有被根对象直接或间接引用的对象，就会被回收。</p>
<ul>
<li><p>java虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象</p>
</li>
<li><p>扫描堆中的对象，看是否能够沿着GCRoot对象为起点的引用链找到该对象，找不到，表示可以回收</p>
</li>
<li><p>那些对象可以作为GCRoot？</p>
<ul>
<li>java虚拟机栈中引用的对象</li>
<li>方法区中的类静态属性引用的对象</li>
<li>方法区中的常量引用对象</li>
<li>本地方法栈中的native修饰的对象</li>
<li>加锁的一些对象，也可以作为GCRoot</li>
</ul>
</li>
<li><p>四种引用</p>
<ul>
<li>强引用:常用的引用变量赋值给一个对象，这就是强引用,jvm不会回收强引用</li>
<li>弱引用:SoftReference,当jvm内存空间不足时，会对软引用进行回收。如果jvm的内存空间足够大情况下，是不会对弱引用进行回收的</li>
<li>软引用:WorkReference，不管jvm的内存空间是否足够,只要发生了gc，就会把软引用进行回收</li>
<li>虚引用:相当于没有引用,只能搭配引用队列来进行使用ReferenceQueue。</li>
</ul>
</li>
</ul>
<p>可达性分析算法理论上要求全过程都基于一个能保障一致性的快照中才能进行分析，这意味着必须全程冻结用户线程的运行。</p>
<p>GCRoot继续向下遍历对象图,这一步骤的停顿时间就必定会与java堆容量直接成正比例关系，堆越大，存储的对象越多,对象图结构越复杂,要标记更多对象而产生的停顿时间自然就更大。</p>
<p>为了解决用户线程的停顿时间,引入了三色标记作为工具辅导推导。把遍历对象图过程中遇到的对象，按照”是否访问过”这个条件标记成以下三种颜色:</p>
<ul>
<li>白色:表示对象尚未被垃圾收集器访问过。显然在可达性分析刚刚开始的阶段，所有的对象都是白色的，若在分析结束的阶段，仍然是白色的对象，即代表不可达。</li>
<li>黑色:表示已经被垃圾收集器访问过,且这个对象的所有引用都已经扫描过。黑色的对象代表已经扫描过,它是安全存活的，如果有其他对象引用指向了黑色对象，无须重新扫描一遍。</li>
<li>灰色:表示对象已经被垃圾收集器访问过,但这个对象上至少存在一个引用还没有被扫描过。</li>
</ul>
<p>从三色标记这里可以知道,为什么垃圾收集器在枚举GCRoots的时候，需要将其他用户线程进行冻结。</p>
<ul>
<li>如果垃圾收集线程在工作,用户线程是并发工作的，收集器在对象图上标记颜色,同时用户线程在修改引用关系-即修改对象图的结构,这可以会出现两种问题:<ul>
<li>把原本消亡的对象错误标记为存活，这是可以容忍的,下次垃圾收集器在工作时，就可以回收这些浮动垃圾。</li>
<li>把原本存活的对象错误标记为已消亡，这是不能忍受的错误。程序出现错误。</li>
</ul>
</li>
</ul>
<p>致命错误是如何产生的:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731003407781.png" alt="image-20220731003407781"></p>
<p>一下两个条件同时满足时,会产生对象消失问题,即原本应该是黑色的对象被误标为白色:</p>
<ul>
<li>赋值器插入了一条或多条从黑色对象到白色对象到新引用；</li>
<li>赋值器删除了全部从灰色对象到该白色对象到直接或间接引用</li>
</ul>
<p>由此产生两种解决方案:</p>
<ul>
<li>增量更新<ul>
<li>破坏的第一个条件,当黑色对象插入新的指向白色对象的引用关系时,就将这个新插入的引用记录下来,等并发扫描结束之后，再将这些记录过的引用关系中的黑色对象为根，重新扫描一次。这可以简化理解为,黑色对象一旦新插入了指向白色对象的引用之后,它就变回灰色对象。</li>
</ul>
</li>
<li>原始快照<ul>
<li>当灰色对象要删除指向白色对象的引用关系时,就将这个要删除的引用记录下来,在并发扫描结束之后,再将这些记录过的引用关系中的灰色对象为根，重新扫描一次。</li>
</ul>
</li>
</ul>
<h3 id="2、垃圾回收算法"><a href="#2、垃圾回收算法" class="headerlink" title="2、垃圾回收算法"></a>2、垃圾回收算法</h3><h4 id="2-0-垃圾回收算法的分代收起理论"><a href="#2-0-垃圾回收算法的分代收起理论" class="headerlink" title="2.0  垃圾回收算法的分代收起理论"></a>2.0  垃圾回收算法的分代收起理论</h4><p>商用虚拟机的垃圾收集器大多遵循分代收集的理论进行设计的。主要分为三个分代假说:</p>
<ul>
<li>弱分代假说:绝大多数对象都是朝生夕死的</li>
<li>强分代假说:熬过越多次垃圾收集过程的对象就越难以消亡。</li>
<li>跨代引用假说:跨代引用相对于同代引用来说仅占极少数。</li>
</ul>
<p>依据这条假说，我们就不应再为了少量的跨代引用去扫描整个老年代，也不必浪费空间专门记录每一个对象是否存在及存在哪些跨代引用，只需在新生代上建立一个全局的数据结构（该结构被称为“记忆集”，Remembered Set），这个结构把老年代划分成若干小块，标识出老年代的哪一块内存会存在跨代引用。此后当发生Minor GC时，只有包含了跨代引用的小块内存里的对象才会被加入到GC Roots进行扫描。</p>
<p>新生代收集(Minor GC&#x2F;Young GC)：指目标只是新生代的垃圾收集</p>
<p>老年代收集(OldGC&#x2F;Major GC): 指目标只是老年代的垃圾收集。目前只有cms收集器会单独收集老年代的行为。</p>
<p>混合收集(Mixed GC): 指目标是收集整个新生代以及部分老年代的垃圾收集。目前只有G1收集器会有这种行为。</p>
<p>整堆收集(Full GC): 收集整个java堆和方法区的垃圾收集。</p>
<h4 id="2-1-标记清理算法"><a href="#2-1-标记清理算法" class="headerlink" title="2.1 标记清理算法"></a>2.1 标记清理算法</h4><p>标记清理算法:沿着GCRoot对象的引用链去找,扫描堆中的空间,找出所有不被GCRoot直接或者间接引用的对象,然后进行标记。标记完成之后,会把这些标记完的对象进行清除，清除只是将空间的起始地址进行了一个记录,放入到了空间列表，下一次有对象来就直接使用这个空闲列表里面的空间直接进行覆盖即可。</p>
<p>优点:速度相对较快，因为它没有真正意义上对空间进行清除。</p>
<p>缺点：会产生内存碎片。不是连续的内存空间，而是像碎片一样的散列开的空间。</p>
<p>执行效率不稳定,如果java堆中包含大量对象,而且其中大部分是需要被回收的这时必须进行大量标记和清除掉动作，导致标记和清除两个过程的执行效率懂随着对象增长而降低。</p>
<h4 id="2-2-标记整理算法"><a href="#2-2-标记整理算法" class="headerlink" title="2.2 标记整理算法"></a>2.2 标记整理算法</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727151030587.png" alt="image-20220727151030587"></p>
<p>标记阶段还是一样的，沿着GCRoot的引用链进行遍历,找到所有不呢GCRoot直接会间接引用的对象，进行标记。</p>
<p>整理: 会将标记对象空间后面的空间往前进行移动整理.可以解决内存碎片问题</p>
<p>缺点：因为你要将空间进行移动，所以涉及到对象引用也要跟着移动到的问题。需要效率会比标记清理会低一些。而且在移动的时候，会有stw暂停用户线程。</p>
<h4 id="2-3-复制算法："><a href="#2-3-复制算法：" class="headerlink" title="2.3 复制算法："></a>2.3 复制算法：</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727152038454.png" alt="image-20220727152038454"></p>
<p>复制算法会开辟一个一摸一样大小的空间。然后在原有空间的基础上做垃圾标记，也是使用沿着GCRoot的引用链，找到所有被GCRoot直接或间接引用的对象，然后做出标记。然后在被GCRoot引用的对象放入到to(新的空间)里面,将form中的空间进行清除。清除完后,将to和from进行替换操作。to变成了from,from变成了to。</p>
<p>优点：不会产生内存碎片</p>
<p>缺点: 要使用两份的空间</p>
<p>所以在jvm中新生代里面采用了我们复制算法，但对其进行优化，jvm中from区和to区占比为8:1，也就是jvm认为90%的新生代对象都是早生夕死的。所以才可以设计。但是存在一个问题，就是当我们的清理垃圾不够的时候，也就是说我们的from空间的值大于to空间，那么怎么进行交换呢，就需要使用我们的分配担保，也就是当内存不足时，去使用一下其他的内存空间，一般都是老年代的空间。</p>
<h4 id="2-4-垃圾回收算法重要概念"><a href="#2-4-垃圾回收算法重要概念" class="headerlink" title="2.4 垃圾回收算法重要概念:"></a>2.4 垃圾回收算法重要概念:</h4><h5 id="2-4-1-根节点枚举"><a href="#2-4-1-根节点枚举" class="headerlink" title="2.4.1  根节点枚举"></a>2.4.1  根节点枚举</h5><p>可达性分析算法从GCRoots集合找引用链来决定哪些对象为垃圾对象。</p>
<p>固定的可作为GCRoots的节点主要在全局性的引用与执行上下文。</p>
<p>所有的收集器在根节点枚举这一步骤是都是必须暂停用户线程，因此毫无疑问根节点枚举与之前提及的整理内存碎片一样会面临相似的stw问题。</p>
<p>为什么需要所有的用户线程懂必须在一个能保障一致性的快照里?</p>
<p>就是因为枚举根节点的时候,如果其他的线程不进行暂停的话，就会产生的新的根节点，根节点的分析结果不会是准确的。所以导致了枚举根节点是必须是停顿的。</p>
<p>安全点:</p>
<p>程序执行时并非所有地方都能停下来开始GC，只有在特定的位置才能停顿下来开始GC，这些位置称为“安全点（Safepoint）”</p>
<p>安全点的选择标准:</p>
<blockquote>
<p>Safe Point 的选择很重要，如果太少可能导致GC等待的时间太长，如果太频繁可能导致运行时的性能问题。大部分指令的执行的时间都非常短暂，通常会根据“是否具有让程序长时间执行的特征”为标准。比如：选择一些执行时间较长的指令作为Safe Point，如方法调用、循环跳转和异常跳转等。</p>
</blockquote>
<p>如何让线程跑到最近的安全点然后停顿下来。两种方案：</p>
<ul>
<li>抢先式中断<ul>
<li>首先中断所有的线程.如果还有线程不在安全点,就恢复线程，让线程跑到安全点</li>
</ul>
</li>
<li>主动式中断<ul>
<li>设置一个中断标志,各个线程运行到saftpoint的时候主动轮询这个标志，如果中断标志为真，则将进行中断挂起。</li>
</ul>
</li>
</ul>
<p>记忆集：</p>
<p>记忆集是一种用于记录从非收集区域指向收集区域的指针集合的抽象数据结构。</p>
<p>目的:为了避免跨代引用时,需要去全表扫描非收集器域。</p>
<p>因为收集器只需要通过记忆集判断出某一块非收集区域是否存在执行收集区域的指针就可以了，并不需要了解这些跨代指针的全部实现细节.</p>
<p>选择更为粗旷的记录粒度来节省记忆集的存储和维护成本,可供选择的记录精度:</p>
<p>1、对象精度:每一个记录精确到一个对象,该对象里有字段含有跨代指针</p>
<p>2、卡精度:每一个记录精确到一块内存区域,该区域有对象含有跨代指针。</p>
<p>3、字长精度:每一个记录确保到一个机器字长,该字包含跨代指针。</p>
<p>卡表:</p>
<p>第三种卡精度我们称为卡表(Card Table)的方式去实现记忆集。</p>
<p>卡表是记忆集的一种具体实现方式.</p>
<p>卡表定义了记忆集的记录精度、与堆内存的映射关系等。</p>
<p>卡表的实现就是一个简单的字节数组。每一个元素懂对应着其标识的内存区域中一块特定大小的内存块，这个内存块被称为卡页。</p>
<p>卡页大小都是以2的N次幂的字节数.</p>
<p>一个卡页的内存中通常包含不止一个对象,只要卡页内有一个对象的字段存在着跨代指针，那就将对应卡表的数组元素的值标识为1，称为这个元素变脏，没有则标识为0.在垃圾收集发生时,只要筛选出卡表中变脏的元素,就能轻易得出哪些卡页内存块中包含跨代指针，把它加入GCRoot中一并扫描即可。</p>
<p>卡表怎么变脏:其他的分代区域对象引用了本区域对象时,其对应的卡表元素就应该变脏，变脏时间点原则上就应该发生在引用类型字段复制的那一刻。</p>
<h3 id="3、分代垃圾回收"><a href="#3、分代垃圾回收" class="headerlink" title="3、分代垃圾回收"></a>3、分代垃圾回收</h3><p>jvm虚拟机中不会使用单一的清理算法，它会根据需要使用的不同的垃圾回收算法，就是分代算法。</p>
<p>jvm将堆中的内存分为新生代、老年代.</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727153415636.png" alt="image-20220727153415636"></p>
<p>新生代划分为三个小区域分别是：伊甸园区、幸存区from、幸存区to。</p>
<p>为什么要做这样一个区域划分呢?</p>
<p>主要是java中的有些对象需要长时间使用，这些长时间使用的对象放入到老年代，新声代中存放一些使用完之后，可以丢弃的对象，这样就可以根据对象的生命周期的不同来使用不同的垃圾回收算法.新生代因为要处理的都是一些朝生夕死的对象，所以发生垃圾回收的比较频繁。老年区因为存储着需要长时间需要的对象，需要发生垃圾回收不是很频繁。</p>
<h5 id="流程："><a href="#流程：" class="headerlink" title="流程："></a>流程：</h5><ul>
<li>对象首先分配在新生代,当新生代的内存空间不足时,会触发minor gc，去进行垃圾回收.</li>
<li>伊甸园和幸存区from存活的对象使用copy算法复制到to中,存活的对象年龄加1.并且交换form和to。</li>
<li>minor gc会触发stop the world ，暂停其他用户的线程,等垃圾回收结束,用户线程才恢复运行</li>
<li>当对象寿命超过阈值时,会晋升至老年代,最大寿命时15(4bit)</li>
<li>在老年代空间不足,会先尝试触发minor gc，如果之后空间仍然不足,那么就会触发full gc，stw的时间更长。</li>
<li>老年代使用的算法有可能是标记清除也有可能是标记整理</li>
<li>大对象他会直接跳过新声代，直接放入到老年代</li>
</ul>
<h4 id="4、jvm的参数"><a href="#4、jvm的参数" class="headerlink" title="4、jvm的参数"></a>4、jvm的参数</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727164543590.png" alt="image-20220727164543590"></p>
<p>-Xms20m -Xmx20m -Xmn10m -XX:+UseSerialGC -XX:+ProintGCDetails -verbose:gc</p>
<h3 id="4、垃圾回收器"><a href="#4、垃圾回收器" class="headerlink" title="4、垃圾回收器"></a>4、垃圾回收器</h3><h4 id="4-1-串行"><a href="#4-1-串行" class="headerlink" title="4.1 串行"></a>4.1 串行</h4><ul>
<li>单线程</li>
<li>堆内存较小，适合个人电脑</li>
</ul>
<p>-XX:+UserSerialGC&#x3D;Serial+SerialOld 开启串行垃圾回收器的参数</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727185559919.png" alt="image-20220727185559919"></p>
<p>Serial: 新生代:复制算法</p>
<p>SerialOld：老年代：标记清理算法</p>
<p>当垃圾回收线程运行的时候,其他的用户线程会阻塞住。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="4-2-吞吐量优先（parallel-怕我no-）"><a href="#4-2-吞吐量优先（parallel-怕我no-）" class="headerlink" title="4.2 吞吐量优先（parallel(怕我no)）"></a>4.2 吞吐量优先（parallel(怕我no)）</h4><ul>
<li>多线程</li>
<li>堆内存较大，多核cpu</li>
<li>让单位时间内，STW的时间最短</li>
<li>开启吞吐量优先的参数:-XX:+UseParallelGC~-XX:+UseParallOldGC jdk1.8下默认是开启的</li>
<li>控制吞吐量优先的线程数:-XX:ParalleGCThreads&#x3D;n</li>
<li>-XX:+UseAdaptiveSizePolicy，自适应的大小调整策略.主要是调整新声代的大小</li>
<li>-XX:GCTimeRatio（raixio）&#x3D;ratio:根据你所设置的目标去尝试调整堆的大小 1&#x2F;(1+ratio)</li>
<li>-XX:MaxGCPauseMillis&#x3D;ms :暂停对毫秒数 默认值为:200毫秒</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727190355563.png" alt="image-20220727190355563"></p>
<p>Parallel scanvenge 新生代收集器，会让我们的用户线程运行到我们的安全点，然后去执行我们的垃圾回收线程，去回收垃圾。复制算法。</p>
<p>Prallel old老年代的收集器。</p>
<h4 id="4-3-响应时间优先"><a href="#4-3-响应时间优先" class="headerlink" title="4.3 响应时间优先"></a>4.3 响应时间优先</h4><ul>
<li>多线程</li>
<li>堆内存较大，多核cpu</li>
<li>重点:尽可能让单次STW到时间最短</li>
</ul>
<p>Cms:ConCurrentMarkSweep :并发的标记清理的垃圾回收器，是一种以获得最短回收停顿时间为目标的收集器，标记清楚算法，运作过程：初始标记,并发标记，重新标记，并发清除,收集结束后会产生大量空间碎片。</p>
<p>并行: 是在同一时刻执行多个事情</p>
<p>并发；是指在同一时间段内执行多个事情</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220727233119094.png" alt="image-20220727233119094"></p>
<p>流程:</p>
<ul>
<li>多个用户线程正在执行，到达安全点，会触发初始标记，初始标记只会标记一些根对象,初始标记完成后,用户线程恢复运行，垃圾回收线程会执行并发标记，这时其他的用户线程都是可以执行的,因为其他线程也在运行，就有可能你标记为的垃圾，会被改动，所以需要再次重新标记。重新标记完成之后，会触发了并发清理,清除阶段是清理删除掉标记阶段判断的已经死亡的对象，由于不需要移动存活对象，所以这个也可以与用户线程同时并发进行。</li>
</ul>
<p>参数：-XX:+UseConcMarkSweepGC~ -XX:+UseParNewGC~SerialOld</p>
<p>-XX:ConcGCThreads&#x3D;threads 并发线程素</p>
<p>-XX:+CMSScavengeBeforeRemark：当我们要去执行重新标记之前，会执行一个新声代的垃圾回收。使用ParNewGc去做。</p>
<p>serial：新声代的复制算法</p>
<p>serial old使用的是标记清理算法</p>
<p>只不过是单线程的，串行。</p>
<p>stw会有点长。</p>
<p>ParNew基于新声代的复制算法。</p>
<p>cms是基于老年代的标记清理算法。以获取最短回收停顿时间为目标的收集器。 初始表示、并发标记、重新标记、标记清理。</p>
<p>一个是并发。</p>
<p>1、无法清理浮动垃圾，线程还在使用，所以还有产生一些垃圾。</p>
<p>2、占用cpu资源。</p>
<p>3、标记清理的算法，所以会出现内存碎片的问题。</p>
<p>cms一些问题：</p>
<p>1、并发回收导致cpu资源紧张</p>
<p>在并发阶段,它虽然不会导致用户线程停顿,但却会因为占用了一部分线程而导致应用程序变慢，降低程序的吞吐量。cms默认开启的回收线程数是:(cpu核心数+3)&#x2F;4,当cpu核心数不足四个时,cms对用户程序的影响就可能变得很大。</p>
<p>2、无法清理浮动垃圾</p>
<p>在cms的并发标记和并发清理阶段，用户线程还在继续运行，就还会伴随有新的垃圾对象不断产生,但这一部分垃圾对象是出现在标记过程结束以后，cms无法在当次收集中处理掉它们,只好留到下一次垃圾收集时再清理掉。这一部分垃圾被称为”浮动垃圾”。</p>
<p>3、内存碎片问题</p>
<p>cms是一款基于”标记-清理”算法实现的回收器,这意味着回收结束时会有内存碎片产生。</p>
<p>4、并发失败</p>
<p>cms是基于标记-清理的算法实现的回收器，所以会产生的内存碎片，而一旦内存碎片过大时,就有可能新生代和老年代因为内存碎片过多，就会长生并发失败。</p>
<h4 id="4-4-G1（Garbage-first）"><a href="#4-4-G1（Garbage-first）" class="headerlink" title="4.4 G1（Garbage first）"></a>4.4 G1（Garbage first）</h4><ul>
<li><p><font color="red">G1目标是在延迟可控的情况下获得尽可能高的吞吐量,所以才被称为”全功能收集器”。</font></p>
</li>
<li><p>G1是一个并行回收器,它把堆内存分割为很多不相关的区域(region)。使用不同的region来表示Eden、幸存区from、幸存去to、老年代等。</p>
</li>
<li><p>G1 Gc有计划避免在整个Java堆中进行全区域的垃圾收集。G1跟踪各个Region里面的垃圾堆积的价值大小(回收所获得的空间大小以及所需时间的经验值),在后台维护一个优先列表，每次根据允许的收集时间,优先回收价值最大的Region。</p>
</li>
<li><p>由于这种方式的侧重点在于回收垃圾最大量的区间(Region)，所以我们给G1一个名字:垃圾优先(Garbage first)</p>
</li>
<li><p>G1是一款面向服务端应用的垃圾收集器.主要针对配备多核cpu及大容量内存多机器。</p>
</li>
<li><p>jdk中不是默认的垃圾回收器,需要使用-XX:+UseG1GC来启用</p>
</li>
</ul>
<p>jdk1.9产生的新的垃圾回收器。</p>
<p>G1的特点:</p>
<ul>
<li><p>并行与并发</p>
<ul>
<li>并行性:G1在回收期间,可以有多个gc线程同时工作,有效利用多核计算能力。此时用户线程STW。</li>
<li>并发性:G1拥有与应用程序交替执行的能力,部分工作可以和应用程序同时执行，因此，一般来说，不会在整个回收阶段发生完全阻塞应用程序的情况。</li>
</ul>
</li>
<li><p>分代收集</p>
<ul>
<li>从分代上看,G1依然属于分代型垃圾回收器,它会区分年轻代和老年代,年轻代依然有Eden区和幸存区。但从堆堆结构上看，它不要求整个Eden区、年轻代或者老年代都是连续的，也不再坚持固定大小和固定数量。</li>
<li>将堆内存分为若干个区域(region)，这些区域中包含了逻辑上的年轻代和老年代。</li>
<li>同时兼顾年轻代和老年代。</li>
</ul>
</li>
<li><p>空间整和</p>
<ul>
<li>cms:”标记-清楚”算法、内存碎片、若干次GC后进行一次碎片整理</li>
<li>G1从整体来看是基于标记-整理算法，但从局部上来看是基于复制算法来实现，所以无论如何都不会产生空间碎片。</li>
</ul>
</li>
<li><p>可预测的停顿</p>
<ul>
<li>这是G1的一大优势。G1能建立可预测的停顿时间模型,能让使用者明确指定在一个长度为m毫秒的时间片段内,消耗在垃圾收集上的时间不得超过n毫秒。</li>
<li>G1只所以能建立可预测的停顿模型，就是因为有计划地避免在整个java堆中进行全区域的垃圾收集。G1跟踪各个Region里面的垃圾堆积的价值大小(回收所 获得的空间大小以及回收所需时间的经验值)，在后台维护了一个优先列表，每次根据允许的收集时间，优先回收价值最大的Region。保证了G1收集器在有限的时间内可以获取尽可能高的收集效率。</li>
</ul>
<p>G1的缺点:</p>
<p>相较于cms,G1还不具备全方位、压倒性优势。比如用户线程在运行过程中,G1无论是为了垃圾收集产生的内存占用还是程序运行时的额外执行负载,都要比cms要高。</p>
<p>小内存应用上cms的表现大概率会犹豫g1.</p>
</li>
</ul>
<p>G1的重要参数：</p>
<ul>
<li>-XX:+UseG1GC：手动的使用g1收集器执行内存回收任务。</li>
<li>-XX:G1HeapRegionSize： 设置每个region的大小，值是2的幂，范围是1m到32m之间，目标是根据最小的java的堆大小划分出约2048个区域。</li>
<li>-XX:MaxGCPauseMillils 设置期望达到最大GC停顿时间指标.默认值是200ms。</li>
<li>-XX:ParallelGCThread 设置stw工作线程数的值,最多设置为8</li>
<li>-XX:ConcGCThreads 设置并发标记的线程数,将n设置为并发垃圾回收线程数的1&#x2F;4左右。</li>
<li>-XX:InitiatingHeapOccupancyPercent：设置触发并发GC周期的java堆占用率阈值。</li>
</ul>
<p>C1的基本思想：</p>
<p>G1将java堆划分为多个大小相等的独立区域(Region)，每一个Region都可以根据需要，扮演新生代代Eden区，幸存去、老年代区等,根据不同的Region采用不同的策略去进行处理。</p>
<p>Region中还有一类特殊的Humongous区域,专门用来存储大对象。G1认为只要大小超过了一个Region容量一半的对象即可绑定为大对象。可以通过参数:-XX:G1HeapRegionSize设定,取值范围为1mb～32mb,且应为2的N次幂。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220729232416628.png" alt="image-20220729232416628"></p>
<p>G1的核心思想在于:</p>
<p>有计划的避免在整个java堆中进行全局域的垃圾收集。</p>
<p>更具体的处理思路是让G1收集器去跟踪各个region里面的垃圾堆积的价值大小,价值即回收所获得的空间大小以及回收所需时间的经验值,然后在后台维护一个优先级列表，每次根据用户设定允许的收集停顿时间，优先处理回收价值收益最大的region.这也就是Garbage frist的由来。</p>
<p>G1收集器的运作过程大致可划分为一下四个步骤：</p>
<ul>
<li>初始标记:仅仅只是标记一下GCRoots能直接关联到的对象,并且修改TAMS(top at mark start：用于记录region并发回收新对象分配区域，其中的对象默认不会被回收)，让下一阶段用户线程并发运行时,能正确地在可用的Region中分配新对象。这个阶段需要停顿线程，但耗时很短，而且是借用进行Minor GC的时候同步完成的，所以G1收集器在这个阶段实际并没有额外的停顿。</li>
<li>并发标记：从GCRoots开始对堆中对象进行可达性分析,递归扫描整个堆里的对象图,找出要回收的对象,这阶段耗时较长，但可与用户程序并发执行。当对象图扫描完成以后,还要重新处理SATB(原始快照:并发执行过程中，三色标记可能会出现对象丢失的情况，所以使用原始快照来进行解决，就是将在我们的扫描标记的过程中有可能在并发标记的过程中有可能会删除我们的引用关系，所以需要一个原始快照来记录这些被删除的对象，然后在扫描完成之后，在对这个快照里面的对象进行扫描)记录下的并发时引用变动的对象。</li>
<li>最终标记:对用户线程做另一个短暂的暂停,用于处理并发阶段结束后仍遗留下来的最后那少量的SATB记录。</li>
<li>筛选回收：负责更新Region的统计数据，对各个Region的回收价值和成本进行排序,根据用户所期望的停顿时间来制定回收计划，可以自由选择任意多个Region构成回收集,然后把决定回收的那一部分Region的存活对象复制到空的Region中,在清理掉整个旧Region的全部空间。这里的操作会暂停用户线程。有多条收集器线程并行完成的。</li>
</ul>
<p>可以由用户指定的提顿时间时G1收集器很强大的一个功能，设置不同的期望停顿时间,可使得G1在不同应用场景中取得关注吞吐量和关注延迟之间的最佳平衡。</p>
<h3 id="实战-内存分配与回收策略"><a href="#实战-内存分配与回收策略" class="headerlink" title="实战:内存分配与回收策略"></a>实战:内存分配与回收策略</h3><p>对象的内存分配，从概念来讲,一应该都是在堆上分配,（也有栈上的）。</p>
<p>对象大小超过阈值，也有可能直接分配到老年代。</p>
<p>1、<font color="orange">对象优先分配在Eden区,但Eden区垃圾不足时，会触发minor GC</font></p>
<p>2、可以通过使用参数-XX:Survior-Ratio&#x3D;8决定新生代中的Eden区与幸存区的比列8:1</p>
<p>3、长期存活的对象将进入到老年代,虚拟机给每个对象定义了一个对象年龄(age)计数器,存储在对象头中.</p>
<p>4、对象通常在Eden区里诞生,如果经过第一次Minor GC后仍然存活,并且能够被幸存区容纳的话，该对象会移动到幸存区中,并且将其对象年龄设为1岁。对象在幸存区中每熬过一次GC年龄就加1岁,当它的年龄增加到一定程度,就会被晋升到老年代(15 4bit)。年龄阈值路通过参数-XX:MaxTenuringThreadOld进行设置。</p>
<h3 id="虚拟机中自带工具的使用"><a href="#虚拟机中自带工具的使用" class="headerlink" title="虚拟机中自带工具的使用"></a>虚拟机中自带工具的使用</h3><h4 id="jps虚拟机进程状态工具"><a href="#jps虚拟机进程状态工具" class="headerlink" title="jps虚拟机进程状态工具"></a>jps虚拟机进程状态工具</h4><p>作用：</p>
<ul>
<li>列出正在执行的虚拟机进程,并显示虚拟机执行主类名称以及这些进程的本地虚拟机唯一id。</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731150125688.png" alt="image-20220731150125688"></p>
<h4 id="jstat-虚拟机统计信息监视工具"><a href="#jstat-虚拟机统计信息监视工具" class="headerlink" title="jstat 虚拟机统计信息监视工具"></a>jstat 虚拟机统计信息监视工具</h4><p>作用:用于监视虚拟机各种运行状态信息的命令工具。可以实现本地或者远程虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据。</p>
<p>命令格式:</p>
<pre class=" language-bash"><code class="language-bash">jstat <span class="token punctuation">[</span>option vmid<span class="token punctuation">]</span>
</code></pre>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731151137516.png" alt="image-20220731151137516"></p>
<h4 id="jinfo：java配置信息工具"><a href="#jinfo：java配置信息工具" class="headerlink" title="jinfo：java配置信息工具"></a>jinfo：java配置信息工具</h4><p>作用:实时查看和调整虚拟机各项参数。使用jps命令的-v参数可以参考虚拟机启动时显示执行的参数列表,没有显示执行的参数,可以通过jinfo -flag进行查询</p>
<pre class=" language-java"><code class="language-java">jinfo <span class="token punctuation">[</span>option<span class="token punctuation">]</span> pid
</code></pre>
<h4 id="jmap-：java内存映像工具"><a href="#jmap-：java内存映像工具" class="headerlink" title="jmap ：java内存映像工具"></a>jmap ：java内存映像工具</h4><p>作用：用于生成堆转储快照(一般称为heapdump或dump).还可以查询finalize执行队列、java堆和方法区的详细信息，如空间使用率、当前用的是哪种收集器等。</p>
<p>jmap命令格式:</p>
<pre class=" language-java"><code class="language-java">jmap <span class="token punctuation">[</span>option<span class="token punctuation">]</span> vmid
</code></pre>
<p>option选项的合法值与具体含义:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731153507788.png" alt="image-20220731153507788"></p>
<h4 id="jhat：虚拟机堆转储快照分析工具"><a href="#jhat：虚拟机堆转储快照分析工具" class="headerlink" title="jhat：虚拟机堆转储快照分析工具"></a>jhat：虚拟机堆转储快照分析工具</h4><p>作用:jhat命令与jmap搭配使用，来分析jmap生成的堆转储快照.</p>
<pre class=" language-bash"><code class="language-bash">jhat 1.bin
</code></pre>
<h4 id="jstack：java堆栈跟踪工具"><a href="#jstack：java堆栈跟踪工具" class="headerlink" title="jstack：java堆栈跟踪工具"></a>jstack：java堆栈跟踪工具</h4><p>作用:用于生成虚拟机当前时刻的线程快照(一般称为dump文件)。</p>
<p>线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合,生成线程快照的目的通常是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致长时间挂起等。</p>
<p>jstack [OPTION] VMID</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731160223031.png" alt="image-20220731160223031"></p>
<p>使用jstack查看线程堆栈信息。</p>
<pre class=" language-java"><code class="language-java">jstack vmid
</code></pre>
<h3 id="可视化故障处理工具"><a href="#可视化故障处理工具" class="headerlink" title="可视化故障处理工具"></a>可视化故障处理工具</h3><h4 id="jHSDB：基于服务性代理堆调试工具"><a href="#jHSDB：基于服务性代理堆调试工具" class="headerlink" title="jHSDB：基于服务性代理堆调试工具"></a>jHSDB：基于服务性代理堆调试工具</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731162106875.png" alt="image-20220731162106875"></p>
<h4 id="jconsole-java监视与管理控制台"><a href="#jconsole-java监视与管理控制台" class="headerlink" title="jconsole: java监视与管理控制台"></a>jconsole: java监视与管理控制台</h4><p>作用:可视化监视、管理工具。通过JMX等MBean对系统进行信息收集和参数动态调整。</p>
<p>使用jconsole命令打开软件</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731163755492.png" alt="image-20220731163755492"></p>
<h4 id="VisualVm：多合一故障处理工具"><a href="#VisualVm：多合一故障处理工具" class="headerlink" title="VisualVm：多合一故障处理工具"></a>VisualVm：多合一故障处理工具</h4><p>作用:运行监视和故障处理程序之一。</p>
<p>特点:</p>
<ul>
<li>显示虚拟机进程以及进程的配置、环境信息（jps、jinfo）。</li>
<li>监视应用程序的处理器、垃圾收集、堆、方法区以及线程的信息（jstat、jstack）。</li>
<li>dump以及分析堆转储快照（jmap、jhat）。</li>
<li>方法级的程序运行性能分析，找出被调用最多、运行时间最长的方法。</li>
<li>离线程序快照：收集程序的运行时配置、线程dump、内存dump等信息建立一个快照，可以将快照发送开发者处进行Bug反馈。</li>
</ul>
<h3 id="垃圾回收调优："><a href="#垃圾回收调优：" class="headerlink" title="垃圾回收调优："></a>垃圾回收调优：</h3><p>1、确定gc垃圾回收器。</p>
<p>2、使用工具查看一下gc的运行情况，gc比较频繁的区域在那。然后找打问题，然后去解决这个问题。</p>
<p>3、先去查看一下自身代码是否出现问题，如果出现了一次性查询过多的对象、使用了Map去缓存了太多的数据，也有可能会造成内存溢出。</p>
<p>4、会尝试去新生代进行调优:</p>
<ul>
<li><p>新生代的对象都是根据我们的分带假说来的，也就是所有的新生代的对象都是朝生夕死。</p>
</li>
<li><p>所有的new操作所创建的对象都会在新生代中进行分配对象，在TLAB中进行分配，也就是线程本地分配缓存区。为了解决并发创建对象的问题。使用的是隔离的策略来解决并发的问题。 </p>
</li>
<li><p>死亡对象的回收代价是零</p>
</li>
<li><p>MinorGC的时间远远低于FullGC。 </p>
</li>
<li><p>基于这些特点需要对其进行优化的话，可以适当的调整一下堆堆大小。</p>
</li>
<li><p>-Xmn堆参数可以设置我们的堆内存大小。</p>
</li>
<li><p><font color="red">新生代的大小要适当，如果新生代的内存过小，会导致我们minorGC会很频繁，不断出发minorGc会导致我们的stw，会暂停我们的用户线程，会导致我们的响应时间变长。如果minorGC过大，由会产生的问题，就会不变挤压你的老年代的空间。如果老年代的空间过小，那么就可能会触发我们的FullGC。所以新生代的选择一定要适当。然后我们的jvm给出的建议是在我们的堆空间的25以上，50%一下，可以适当进行调控。</font></p>
</li>
<li><p>合适的大小可以容纳所有的并发量*(请求-响应)的数据。</p>
</li>
<li><p>老年代的大小能保留(当前活跃对象+需要晋升对象)</p>
</li>
</ul>
<p>5、老年代内存其实也是越大越好的，因为大对象，长时间存活的对象，都会存储在我们的老年代中，如果老年代的内存空间不足，会尝试触发一下minorGC，如果mingc，还不能解决，那么就会触发我们的FullGC。将整个java堆进行回收。jdk1.8采用的是cms垃圾收集器。使用标记-清除算法，会产生的内存碎片。如果内存中出现大量碎片，会导致存放不下大对象，就有可能会触发我们的FullGC。所以记得有一个参数，让我们fullGC之后会执行一次我们整理内存碎片。</p>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例:"></a>案例:</h4><p>1、FullGC和MinorGC频繁。可以去适当的调大一下-xmn新生代的大小。</p>
<p>2、请求高峰期发生FullGC，单次暂停时间特别长(cms)</p>
<p>分析:</p>
<p>1、cms先要去开启的gc日志 -XX:+printGC</p>
<p>2、去查看一下我们的cms执行过程中，出现了什么问题。</p>
<p>3、有可能会浪费大量内存的问题，就在于我们的重新标记，不仅需要扫描老年代，还需要去扫描我们的新生代。需要需要打开一个Remark，也就是在cms执行之前，先让我们的minorGC去清理一遍我们的新生代。这样我们的cms扫描的垃圾就会变少了。</p>
<h3 id="内存溢出的问题"><a href="#内存溢出的问题" class="headerlink" title="内存溢出的问题:"></a>内存溢出的问题:</h3><ul>
<li>误用线程池导致的内存溢出 newThreadFixedThreadPool默认的是LinkedBlockingQueue的无界的任务队列，会导致我们的内存溢出。</li>
<li>使用线程池会导致我们的内存溢出。newCache.因为newCache里面最大线程数是integer的最大值。导致生成大量的线程。会导致内存溢出。</li>
<li>一次查询太多数据</li>
<li>类太多</li>
</ul>
<h3 id="类文件结构"><a href="#类文件结构" class="headerlink" title="类文件结构"></a>类文件结构</h3><p>我们都知道java要称一次编译到处运行,那让java程序可以做到这样的就是java的虚拟机已经java的字节码文件.</p>
<p>类文件的结构分析:</p>
<pre class=" language-java"><code class="language-java">ClassFile <span class="token punctuation">{</span>
    u4             magic<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Class 文件的标志</span>
    u2             minor_version<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的小版本号</span>
    u2             major_version<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的大版本号</span>
    u2             constant_pool_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//常量池的数量</span>
    cp_info        constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//常量池</span>
    u2             access_flags<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的访问标记</span>
    u2             this_class<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当前类</span>
    u2             super_class<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//父类</span>
    u2             interfaces_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//接口</span>
    u2             interfaces<span class="token punctuation">[</span>interfaces_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类可以实现多个接口</span>
    u2             fields_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 文件的字段属性</span>
    field_info     fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类会可以有多个字段</span>
    u2             methods_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 文件的方法数量</span>
    method_info    methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类可以有个多个方法</span>
    u2             attributes_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//此类的属性表中的属性数</span>
    attribute_info attributes<span class="token punctuation">[</span>attributes_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//属性表集合</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="魔数（class的文件标志）"><a href="#魔数（class的文件标志）" class="headerlink" title="魔数（class的文件标志）"></a>魔数（class的文件标志）</h4><p>0~3字节,表示它是否是class类型的文件。</p>
<p>ca fe ba ba这是java选择标识的字符。</p>
<pre class=" language-java"><code class="language-java"><span class="token number">0000000</span> ca fe ba ba <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">34</span> <span class="token number">00</span> <span class="token number">23</span> 0a <span class="token number">00</span> <span class="token number">06</span> <span class="token number">00</span> <span class="token number">15</span> <span class="token number">09</span>
</code></pre>
<h4 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h4><p>4～7字节,表示类的版本00 34(52) 表示是java 8</p>
<pre class=" language-java"><code class="language-java"><span class="token number">0000000</span> ca fe ba ba <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">34</span> <span class="token number">00</span> <span class="token number">23</span> 0a <span class="token number">00</span> <span class="token number">06</span> <span class="token number">00</span> <span class="token number">15</span> <span class="token number">09</span>
</code></pre>
<h4 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h4><pre class=" language-java"><code class="language-java">u2 constant_pool_count <span class="token comment" spellcheck="true">//常量池的数量</span>
cp_info constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">//常量池  </span>
</code></pre>
<p>常量池的数量是constant_pool_count-1(常量池计数器是从1开始计数的，将第0项常量空出来是有特殊考虑的，索引值为0代表“不引用任何一个常量池项”).</p>
<p><img src="https://img-blog.csdnimg.cn/cf8144a2e469435fa648133771c37476.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAeHVzaGl5dTE5OTY4MTg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>8~9字节,表示常量池长度,00 23（35）表示常量池有#1～#34项，注意#0项不计入，也没有值</p>
<pre class=" language-java"><code class="language-java"><span class="token number">0000000</span> ca fe ba ba <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">34</span> <span class="token number">00</span> <span class="token number">23</span> 0a <span class="token number">00</span> <span class="token number">06</span> <span class="token number">00</span> <span class="token number">15</span> <span class="token number">09</span>
</code></pre>
<p>第#1项0a表示一个Method信息,00 06和00 15（21）表示它引用了常量池中#6和#21项来获得这个方法的所属类和方法名</p>
<pre class=" language-java"><code class="language-java"><span class="token number">0000000</span> ca fe ba ba <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">34</span> <span class="token number">00</span> <span class="token number">23</span> 0a <span class="token number">00</span> <span class="token number">06</span> <span class="token number">00</span> <span class="token number">15</span> <span class="token number">09</span>
</code></pre>
<p>第#2项09表示一个Field信息，00 16（22）和00 17（23）表示它引用了常量池中#22和#23项来获得这个成员变量的所属类和成员变量名</p>
<pre class=" language-java"><code class="language-java"><span class="token number">0000000</span> ca fe ba ba <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">34</span> <span class="token number">00</span> <span class="token number">23</span> 0a <span class="token number">00</span> <span class="token number">06</span> <span class="token number">00</span> <span class="token number">15</span> <span class="token number">09</span>
<span class="token number">0000020</span> <span class="token number">00</span> <span class="token number">16</span> <span class="token number">00</span> <span class="token number">17</span> <span class="token number">08</span> <span class="token number">00</span> <span class="token number">18</span> 0a <span class="token number">00</span> <span class="token number">19</span> <span class="token number">00</span> 1a <span class="token number">07</span> <span class="token number">00</span> 1b <span class="token number">07</span>  
</code></pre>
<h3 id="javap-工具"><a href="#javap-工具" class="headerlink" title="javap: 工具"></a>javap: 工具</h3><p>自己分析类文件结构太麻烦了，java提供了javap工具来反编译class文件</p>
<pre class=" language-java"><code class="language-java">javap <span class="token operator">-</span>v hello<span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token class-name">Classfile</span> <span class="token operator">/</span>Users<span class="token operator">/</span>kevintam<span class="token operator">/</span>project<span class="token operator">/</span>hello<span class="token punctuation">.</span><span class="token keyword">class</span>
  <span class="token class-name">Last</span> modified <span class="token number">2022</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">31</span><span class="token punctuation">;</span> size <span class="token number">415</span> bytes
  MD5 checksum e9060c88e2810b27a9fbb399c4588e18
  Compiled from <span class="token string">"hello.java"</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">hello</span>
  minor version<span class="token operator">:</span> <span class="token number">0</span>
  major version<span class="token operator">:</span> <span class="token number">52</span>
  flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_SUPER
Constant pool<span class="token operator">:</span>
   #<span class="token number">1</span> <span class="token operator">=</span> Methodref          #<span class="token number">6</span><span class="token punctuation">.</span>#<span class="token number">15</span>         <span class="token comment" spellcheck="true">// java/lang/Object."&lt;init>":()V</span>
   #<span class="token number">2</span> <span class="token operator">=</span> Fieldref           #<span class="token number">16</span><span class="token punctuation">.</span>#<span class="token number">17</span>        <span class="token comment" spellcheck="true">// java/lang/System.out:Ljava/io/PrintStream;</span>
   #<span class="token number">3</span> <span class="token operator">=</span> String             #<span class="token number">18</span>            <span class="token comment" spellcheck="true">// hello world</span>
   #<span class="token number">4</span> <span class="token operator">=</span> Methodref          #<span class="token number">19</span><span class="token punctuation">.</span>#<span class="token number">20</span>        <span class="token comment" spellcheck="true">// java/io/PrintStream.println:(Ljava/lang/String;)V</span>
   #<span class="token number">5</span> <span class="token operator">=</span> Class              #<span class="token number">21</span>            <span class="token comment" spellcheck="true">// hello</span>
   #<span class="token number">6</span> <span class="token operator">=</span> Class              #<span class="token number">22</span>            <span class="token comment" spellcheck="true">// java/lang/Object</span>
   #<span class="token number">7</span> <span class="token operator">=</span> Utf8               <span class="token operator">&lt;</span>init<span class="token operator">></span>
   #<span class="token number">8</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">)</span>V
   #<span class="token number">9</span> <span class="token operator">=</span> Utf8               Code
  #<span class="token number">10</span> <span class="token operator">=</span> Utf8               LineNumberTable
  #<span class="token number">11</span> <span class="token operator">=</span> Utf8               main
  #<span class="token number">12</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
  #<span class="token number">13</span> <span class="token operator">=</span> Utf8               SourceFile
  #<span class="token number">14</span> <span class="token operator">=</span> Utf8               hello<span class="token punctuation">.</span>java
  #<span class="token number">15</span> <span class="token operator">=</span> NameAndType        #<span class="token number">7</span><span class="token operator">:</span>#<span class="token number">8</span>          <span class="token comment" spellcheck="true">// "&lt;init>":()V</span>
  #<span class="token number">16</span> <span class="token operator">=</span> Class              #<span class="token number">23</span>            <span class="token comment" spellcheck="true">// java/lang/System</span>
  #<span class="token number">17</span> <span class="token operator">=</span> NameAndType        #<span class="token number">24</span><span class="token operator">:</span>#<span class="token number">25</span>        <span class="token comment" spellcheck="true">// out:Ljava/io/PrintStream;</span>
  #<span class="token number">18</span> <span class="token operator">=</span> Utf8               hello world
  #<span class="token number">19</span> <span class="token operator">=</span> Class              #<span class="token number">26</span>            <span class="token comment" spellcheck="true">// java/io/PrintStream</span>
  #<span class="token number">20</span> <span class="token operator">=</span> NameAndType        #<span class="token number">27</span><span class="token operator">:</span>#<span class="token number">28</span>        <span class="token comment" spellcheck="true">// println:(Ljava/lang/String;)V</span>
  #<span class="token number">21</span> <span class="token operator">=</span> Utf8               hello
  #<span class="token number">22</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Object
  #<span class="token number">23</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>System
  #<span class="token number">24</span> <span class="token operator">=</span> Utf8               out
  #<span class="token number">25</span> <span class="token operator">=</span> Utf8               Ljava<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream<span class="token punctuation">;</span>
  #<span class="token number">26</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream
  #<span class="token number">27</span> <span class="token operator">=</span> Utf8               println
  #<span class="token number">28</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> aload_0
         <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment" spellcheck="true">// Method java/lang/Object."&lt;init>":()V</span>
         <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// String hello world</span>
         <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
         <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">4</span><span class="token operator">:</span> <span class="token number">8</span>
<span class="token punctuation">}</span>
SourceFile<span class="token operator">:</span> <span class="token string">"hello.java"</span>
</code></pre>
<h3 id="图解的方式执行流程"><a href="#图解的方式执行流程" class="headerlink" title="图解的方式执行流程"></a>图解的方式执行流程</h3><h4 id="1、原始java代码"><a href="#1、原始java代码" class="headerlink" title="1、原始java代码"></a>1、原始java代码</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_1</span><span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> b<span class="token operator">=</span>Short<span class="token punctuation">.</span>Max_VALUE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> c<span class="token operator">=</span>a<span class="token operator">+</span>b<span class="token punctuation">;</span>
     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>编译后的字节码文件:</p>
<pre class=" language-java"><code class="language-java">➜ project javap <span class="token operator">-</span>v  hello<span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token class-name">Classfile</span> <span class="token operator">/</span>Users<span class="token operator">/</span>kevintam<span class="token operator">/</span>project<span class="token operator">/</span>hello<span class="token punctuation">.</span><span class="token keyword">class</span>
  <span class="token class-name">Last</span> modified <span class="token number">2022</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">31</span><span class="token punctuation">;</span> size <span class="token number">428</span> bytes
  MD5 checksum dd710a6b03b3dcc1646a2c38aa2f1bc2
  Compiled from <span class="token string">"hello.java"</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">hello</span>
  minor version<span class="token operator">:</span> <span class="token number">0</span>
  major version<span class="token operator">:</span> <span class="token number">52</span>
  flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_SUPER
Constant pool<span class="token operator">:</span>
   #<span class="token number">1</span> <span class="token operator">=</span> Methodref          #<span class="token number">7</span><span class="token punctuation">.</span>#<span class="token number">16</span>         <span class="token comment" spellcheck="true">// java/lang/Object."&lt;init>":()V</span>
   #<span class="token number">2</span> <span class="token operator">=</span> Class              #<span class="token number">17</span>            <span class="token comment" spellcheck="true">// java/lang/Short</span>
   #<span class="token number">3</span> <span class="token operator">=</span> Integer            <span class="token number">32768</span>
   #<span class="token number">4</span> <span class="token operator">=</span> Fieldref           #<span class="token number">18</span><span class="token punctuation">.</span>#<span class="token number">19</span>        <span class="token comment" spellcheck="true">// java/lang/System.out:Ljava/io/PrintStream;</span>
   #<span class="token number">5</span> <span class="token operator">=</span> Methodref          #<span class="token number">20</span><span class="token punctuation">.</span>#<span class="token number">21</span>        <span class="token comment" spellcheck="true">// java/io/PrintStream.println:(I)V</span>
   #<span class="token number">6</span> <span class="token operator">=</span> Class              #<span class="token number">22</span>            <span class="token comment" spellcheck="true">// hello</span>
   #<span class="token number">7</span> <span class="token operator">=</span> Class              #<span class="token number">23</span>            <span class="token comment" spellcheck="true">// java/lang/Object</span>
   #<span class="token number">8</span> <span class="token operator">=</span> Utf8               <span class="token operator">&lt;</span>init<span class="token operator">></span>
   #<span class="token number">9</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">)</span>V
  #<span class="token number">10</span> <span class="token operator">=</span> Utf8               Code
  #<span class="token number">11</span> <span class="token operator">=</span> Utf8               LineNumberTable
  #<span class="token number">12</span> <span class="token operator">=</span> Utf8               main
  #<span class="token number">13</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
  #<span class="token number">14</span> <span class="token operator">=</span> Utf8               SourceFile
  #<span class="token number">15</span> <span class="token operator">=</span> Utf8               hello<span class="token punctuation">.</span>java
  #<span class="token number">16</span> <span class="token operator">=</span> NameAndType        #<span class="token number">8</span><span class="token operator">:</span>#<span class="token number">9</span>          <span class="token comment" spellcheck="true">// "&lt;init>":()V</span>
  #<span class="token number">17</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Short
  #<span class="token number">18</span> <span class="token operator">=</span> Class              #<span class="token number">24</span>            <span class="token comment" spellcheck="true">// java/lang/System</span>
  #<span class="token number">19</span> <span class="token operator">=</span> NameAndType        #<span class="token number">25</span><span class="token operator">:</span>#<span class="token number">26</span>        <span class="token comment" spellcheck="true">// out:Ljava/io/PrintStream;</span>
  #<span class="token number">20</span> <span class="token operator">=</span> Class              #<span class="token number">27</span>            <span class="token comment" spellcheck="true">// java/io/PrintStream</span>
  #<span class="token number">21</span> <span class="token operator">=</span> NameAndType        #<span class="token number">28</span><span class="token operator">:</span>#<span class="token number">29</span>        <span class="token comment" spellcheck="true">// println:(I)V</span>
  #<span class="token number">22</span> <span class="token operator">=</span> Utf8               hello
  #<span class="token number">23</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Object
  #<span class="token number">24</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>System
  #<span class="token number">25</span> <span class="token operator">=</span> Utf8               out
  #<span class="token number">26</span> <span class="token operator">=</span> Utf8               Ljava<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream<span class="token punctuation">;</span>
  #<span class="token number">27</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream
  #<span class="token number">28</span> <span class="token operator">=</span> Utf8               println
  #<span class="token number">29</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span>I<span class="token punctuation">)</span>V
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> aload_0
         <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment" spellcheck="true">// Method java/lang/Object."&lt;init>":()V</span>
         <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> bipush        <span class="token number">10</span>
         <span class="token number">2</span><span class="token operator">:</span> istore_1
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// int 32768</span>
         <span class="token number">5</span><span class="token operator">:</span> istore_2
         <span class="token number">6</span><span class="token operator">:</span> iload_1
         <span class="token number">7</span><span class="token operator">:</span> iload_2
         <span class="token number">8</span><span class="token operator">:</span> iadd
         <span class="token number">9</span><span class="token operator">:</span> istore_3
        <span class="token number">10</span><span class="token operator">:</span> getstatic     #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">13</span><span class="token operator">:</span> iload_3
        <span class="token number">14</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>                  <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">17</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">4</span><span class="token operator">:</span> <span class="token number">3</span>
        line <span class="token number">5</span><span class="token operator">:</span> <span class="token number">6</span>
        line <span class="token number">6</span><span class="token operator">:</span> <span class="token number">10</span>
        line <span class="token number">7</span><span class="token operator">:</span> <span class="token number">17</span>
<span class="token punctuation">}</span>
SourceFile<span class="token operator">:</span> <span class="token string">"hello.java"</span>
</code></pre>
<h4 id="3、常量池载入运行时常量池"><a href="#3、常量池载入运行时常量池" class="headerlink" title="3、常量池载入运行时常量池"></a>3、常量池载入运行时常量池</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731234931576.png" alt="image-20220731234931576"></p>
<p>运行时常量池是方法区里的一部分。</p>
<h4 id="4、方法字节码载入方法区"><a href="#4、方法字节码载入方法区" class="headerlink" title="4、方法字节码载入方法区"></a>4、方法字节码载入方法区</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731235538783.png" alt="image-20220731235538783"></p>
<h4 id="5、main线程开始运行，分配栈帧内存"><a href="#5、main线程开始运行，分配栈帧内存" class="headerlink" title="5、main线程开始运行，分配栈帧内存"></a>5、main线程开始运行，分配栈帧内存</h4><p>locals:最大操作数 所以分配了四个槽位,存储局部变量。stack:最大深度为2，操作数栈的多少,用于存储数据和字节码指令。由我们的执行引擎去一行一行的去读取方法区里面的执行指令。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220731235711973.png" alt="image-20220731235711973"></p>
<h4 id="6、执行引擎开始执行字节码"><a href="#6、执行引擎开始执行字节码" class="headerlink" title="6、执行引擎开始执行字节码"></a>6、执行引擎开始执行字节码</h4><p>bipush        10</p>
<ul>
<li>将一个byte压入操作数栈(其长度会补齐4个字节)，类似的指令还有</li>
<li>sipush将一个short压入操作数栈(其长度会补齐4个字节)</li>
<li>idc将一个int压入操作数栈</li>
<li>Idc2_w将一个long压入操作数栈(分两次压入，因为long是8个字节)</li>
<li>这里小的数字都是和字节码指令存在一起,超过short范围的数字存入了常量池</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801001453677.png" alt="image-20220801001453677"></p>
<p>Istore_1</p>
<ul>
<li>将操作数栈顶数据弹出，存入局部变量表的slot 1</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801002224424.png" alt="image-20220801002224424"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801002338148.png" alt="image-20220801002338148"></p>
<p>idc #3 接下来应该是给b变量赋值</p>
<ul>
<li>从常量池加载#3数据到操作数栈</li>
<li>注意Short.MAX_VALUE是32767,所以32768&#x3D;Short.MAX_VALUE+1实际是在编译期间计算好的</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801002630959.png" alt="image-20220801002630959"></p>
<p>Istore_2</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801002829273.png" alt="image-20220801002829273"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801002916708.png" alt="image-20220801002916708"></p>
<p>完成a、b的赋值,现在要执行的就是a+b的操作。</p>
<p>iload1：将局部变量1糟位的值读取到数栈中。iload2，是将2多值读到数栈中</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003201107.png" alt="image-20220801003201107"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003222104.png" alt="image-20220801003222104"></p>
<p>使用iadd执行来做a+b的操作</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003314123.png" alt="image-20220801003314123"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003346714.png" alt="image-20220801003346714"></p>
<p>istore 3将数栈中的值取出来放到槽位3中</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003447008.png" alt="image-20220801003447008"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003700806.png" alt="image-20220801003700806"></p>
<p>getstatic #41 去常量池去找成员变量</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003818310.png" alt="image-20220801003818310"></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003839468.png" alt="image-20220801003839468"></p>
<p>iload 3</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801003925851.png" alt="image-20220801003925851"></p>
<p>ivokevirtual #5</p>
<ul>
<li>找到常量池 #5</li>
<li>定位到方法区 java&#x2F;io&#x2F;PrintStram.println:(I)v方法</li>
<li>生成新的栈帧(分配locals、stack等)</li>
<li>传递参数,执行新栈帧中的字节码</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801004146878.png" alt="image-20220801004146878"></p>
<ul>
<li>执行完毕，弹出栈帧</li>
<li>清除main操作数栈内容</li>
</ul>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801004316155.png" alt="image-20220801004316155">最后进行return操作</p>
<ul>
<li>完成main方法调用，弹出main栈帧</li>
<li>程序结束</li>
</ul>
<h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><h4 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h4><ul>
<li>将类的字节码载入方法区中,内部采用c++的instanKlass描述java类,它的重要field有:<ul>
<li>_java_mirrot即java的类镜像,例如对String来说,就是String.class，作用是把klass暴露给java使用</li>
<li>_super即父类</li>
<li>_fields即成员变量</li>
<li>_methods即方法</li>
<li>_constants即常量池</li>
<li>_class_loader即类加载器</li>
<li>_vtable虚方法表</li>
<li>_itable接口方法表</li>
</ul>
</li>
<li>如果这个类还有父类没有加载，先加载父类</li>
<li>加载和链接可能是交替运行的</li>
</ul>
<blockquote>
<p>注意</p>
<p>instanceKlass这样的元数据是存储在方法区(1.8后的元空间内),但_java_mirror是存储在堆中</p>
<p>可以通过前面介绍的HSDB工具查看</p>
</blockquote>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801131753026.png" alt="image-20220801131753026"></p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><ul>
<li><p>验证:验证类是否符合jvm规范,安全性检查。</p>
</li>
<li><p>准备:为static变量分配空间，设置默认值</p>
<ul>
<li>static变量在jdk 7 之前存储与instanceKlass末尾,从JDK7开始，存储与_java_mirror末尾</li>
<li>static变量分配空间和赋值是两个步骤,分配空间在准备阶段完成,赋值在初始化阶段完成</li>
<li>如果static变量是final的基本类型，那么编译阶段值就确定了，赋值在准备阶段完成</li>
<li>如果static变脸是final的，但属于引用类型，那么赋值也会在初始化阶段完成</li>
</ul>
</li>
<li><p>解析:将常量池中的符号引用解析为直接引用</p>
<ul>
<li>符号引用就是仅仅只是一个符号，它并不知道这个对象所处的内存地址，</li>
<li>解析的作用就是将这个符号引用变为直接引用，将这个符号位变成正在的对象的内存地址</li>
</ul>
</li>
</ul>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><clinit>()V方法</p>
<p>初始化即调用<clinit>()V，虚拟机会保证这个类的构造方法的线程安全</p>
<h4 id="发生的时机"><a href="#发生的时机" class="headerlink" title="发生的时机"></a>发生的时机</h4><p>概括来说,类初始化是懒惰的</p>
<ul>
<li>main方法所在的类,总会被首先初始化</li>
<li>首次访问这个类的静态变量或静态方法时</li>
<li>子类初始化，如果父类还没初始化，会引发</li>
<li>子类访问父类的静态变量，只会触发父类的初始化</li>
<li>Class.forName</li>
<li>new 会导致初始化</li>
</ul>
<p>不会导致类初始化的情况</p>
<ul>
<li>访问类的static final静态变量（静本类型和字符串）不会触发初始化</li>
<li>类对象.class不会触发初始化</li>
<li>创建该类的数组不会触发初始化</li>
<li>类加载器的loadClass方法</li>
<li>Class.forName的参数2位false时</li>
</ul>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>以JDK8为例:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>加载哪都类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Bootstrap ClassLoader</td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib</td>
<td>无法直接访问</td>
</tr>
<tr>
<td>Extension ClassLoader</td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext</td>
<td>上级为bootstrap,显示为null</td>
</tr>
<tr>
<td>Application ClassLoader</td>
<td>class path</td>
<td>上级为Extension</td>
</tr>
<tr>
<td>自定义类加载器</td>
<td>自定义</td>
<td>上级为Application</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="启动类加载器"><a href="#启动类加载器" class="headerlink" title="启动类加载器"></a>启动类加载器</h4><p>使用Bootstrap类加载器加载类:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">test1</span> <span class="token punctuation">{</span>
   <span class="token keyword">static</span> <span class="token punctuation">{</span>
       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"static test1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>执行:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">test2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Class<span class="token operator">&lt;</span>test1<span class="token operator">></span> aClass <span class="token operator">=</span> test1<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//拿到是那个类加载器进行加载的</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>输出</p>
<pre class=" language-java"><code class="language-java">java <span class="token operator">-</span>Xbootclasspath<span class="token operator">/</span>a<span class="token operator">:</span><span class="token punctuation">.</span> xxxxxxxx
</code></pre>
<ul>
<li>-Xbootclasspath表示设置bootclasspoah</li>
<li>其中&#x2F;a:.表示将当前目录追加至bootclasspath之后</li>
<li>可以用这个办法替换核心类<ul>
<li>java -Xbootclasspath:<new bootclasspath></li>
<li>java -Xbootclasspath&#x2F;a:&lt;追加路径&gt;</li>
<li>java -Xbootclasspath&#x2F;p:&lt;追加路径&gt;</li>
</ul>
</li>
</ul>
<p>打成jar包的命令：</p>
<pre class=" language-java"><code class="language-java">jar <span class="token operator">-</span>cvf my<span class="token punctuation">.</span>jar xxxxxx
</code></pre>
<h3 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h3><p>它是类加载器的加载类的一个规则。</p>
<p>加载流程:</p>
<p> 一个类加载器查找class和resource时，是通过“委托模式”进行的，它首先判断这个class是不是已经加载成功，如果没有的话它并不是自己进行查找，而是先通过父加载器，然后递归下去，直到Bootstrap ClassLoader，如果Bootstrap classloader找到了，直接返回，如果没有找到，则一级一级返回，最后到达自身去查找这些对象。这种机制就叫做双亲委托。</p>
<p>顺序:发现委托是从下向上,然后具体查找过程却是自上至下。</p>
<p>源码:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> ClassNotFoundException
<span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// First, check if the class has already been loaded</span>
        <span class="token comment" spellcheck="true">//1、检查该类是否已经被加载</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> t0 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token comment" spellcheck="true">//2、有上级的话，委托上级loadClass</span>
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">//3、如果没有上级了,则委托BootstrapClassLoader</span>
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ClassNotFoundException thrown if class not found</span>
                <span class="token comment" spellcheck="true">//如果找不到类则抛出一个classNotfountExection</span>
                <span class="token comment" spellcheck="true">// from the non-null parent class loader</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果仍然没有找到，请按顺序调用findClass方法(每个类加载自己的扩展)来进行加载</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// this is the defining class loader; record the stats</span>
                <span class="token comment" spellcheck="true">//记录耗时</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="headerlink" title="线程上下文类加载器"></a>线程上下文类加载器</h4><p>我们在使用jdbc时,都需要加载Driver驱动,不知道你注意到没有,不写</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span>
</code></pre>
<p>也是可以让com.mysql.jdbc.Driver正确加载到，你知道原因吗</p>
<p>让我们追踪一下源码看看:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DriverManager</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//已注册的 JDBC 驱动程序列表</span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> CopyOnWriteArrayList<span class="token operator">&lt;</span>DriverInfo<span class="token operator">></span> registeredDrivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true">/**
     * Load the initial JDBC drivers by checking the System property
     * jdbc.properties and then use the {@code ServiceLoader} mechanism
     */</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JDBC DriverManager initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过调用这个DriverManager的classLoader发现这个类是由我们的Bootstrap来进行加载的.</p>
<pre class=" language-java"><code class="language-java">System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>DriverManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
null
</code></pre>
<p>打印null,表示它的类加载是Bootstrap ClassLoader,会到JAVA_HOME&#x2F;jre&#x2F;lib下搜索类,但这个路径显然是没有mysql的jar包的,这样问题就来了，在DriverManager的静态代码快中,怎么能正确加载com.mysql.jdbc.Driver呢?</p>
<p>继续看loadInitialDrivers：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String drivers<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            drivers <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> String <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"jdbc.drivers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            drivers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// If the driver is packaged as a Service Provider, load it.</span>
        <span class="token comment" spellcheck="true">// Get all the drivers through the classloader</span>
        <span class="token comment" spellcheck="true">// exposed as a java.sql.Driver.class service.</span>
        <span class="token comment" spellcheck="true">// ServiceLoader.load() replaces the sun.misc.Providers()</span>
        <span class="token comment" spellcheck="true">//1、使用ServerLoader机制记载驱动,即SPI</span>
        AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token operator">&lt;</span>Void<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> Void <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                ServiceLoader<span class="token operator">&lt;</span>Driver<span class="token operator">></span> loadedDrivers <span class="token operator">=</span> ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>Driver<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Iterator<span class="token operator">&lt;</span>Driver<span class="token operator">></span> driversIterator <span class="token operator">=</span> loadedDrivers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">/* Load these drivers, so that they can be instantiated.
                 * It may be the case that the driver class may not be there
                 * i.e. there may be a packaged driver with the service class
                 * as implementation of java.sql.Driver but the actual class
                 * may be missing. In that case a java.util.ServiceConfigurationError
                 * will be thrown at runtime by the VM trying to locate
                 * and load the service.
                 *
                 * Adding a try catch block to catch those runtime errors
                 * if driver not available in classpath but it's
                 * packaged as service and that service is there in classpath.
                 */</span>
                <span class="token keyword">try</span><span class="token punctuation">{</span>
                    <span class="token keyword">while</span><span class="token punctuation">(</span>driversIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        driversIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.initialize: jdbc.drivers = "</span> <span class="token operator">+</span> drivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//2、使用jdbc.driver定义的驱动名加载驱动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>drivers <span class="token operator">==</span> null <span class="token operator">||</span> drivers<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> driversList <span class="token operator">=</span> drivers<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"number of Drivers:"</span> <span class="token operator">+</span> driversList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String aDriver <span class="token operator">:</span> driversList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.Initialize: loading "</span> <span class="token operator">+</span> aDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>aDriver<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                              <span class="token comment" spellcheck="true">//这个就是使用appClassLoader来进行记载</span>
                              <span class="token comment" spellcheck="true">//这里打破了双亲委派机制,因为按照机制来说的，应该是使用BootstrapClassLoader来进行加载，而不是使用appClassLoader来进行记载</span>
                        ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.Initialize: load failed: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>有的时候，jdk需要打破这个双亲委派机制,让应用程序加载器来加载类,否者有些类是无法找到的。</p>
<p>在来看看ServiceLoader机制</p>
<p>仔细说说这个Service Provider Interface(SPI)是一种服务发现机制。</p>
<p>它通过在ClassPath路径下的META-INF&#x2F;services文件夹查找文件，自动加载文件里所定义的类。</p>
<p>约定如下,在jar包的META-INF&#x2F;services包下,以接口全限定名名为文件,文件内容是实现类名称</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801170120400.png" alt="image-20220801170120400"></p>
<p>这样就可以使用</p>
<pre class=" language-java"><code class="language-java">ServiceLoader<span class="token operator">&lt;</span>接口类型<span class="token operator">></span> allImpls<span class="token operator">=</span>ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>接口类型<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Iterator<span class="token operator">&lt;</span>接口类型<span class="token operator">></span> iter<span class="token operator">=</span>allImpls<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>来得到实现类，体现的是面向接口编程+解藕的思想,在下面一些框架中都运用了此思想:</p>
<ul>
<li>JDBC</li>
<li>Servlet初始化器</li>
<li>Spring 容器</li>
</ul>
<p>接着看ServiceLoader.load方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span><span class="token operator">&lt;</span>s<span class="token operator">></span> ServiceLoader<span class="token operator">&lt;</span>s<span class="token operator">></span> <span class="token function">load</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>S<span class="token operator">></span> service<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">//获取线程上下文类加载器</span>
  ClassLoader c1<span class="token operator">=</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//jvm会把我们的应用加载器赋值给它</span>
  <span class="token keyword">return</span> ServiceLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以得知Driver是打破了双亲委派机制的，因为他是使用系统加载器，去委托了应用加载器去进行加载。</p>
<h4 id="破坏双亲委派机制两种方式"><a href="#破坏双亲委派机制两种方式" class="headerlink" title="破坏双亲委派机制两种方式"></a>破坏双亲委派机制两种方式</h4><p>1、就是使用Driver里面的线程上下文加载器来进行破坏。</p>
<p>可以通过Thread.currentThread.getClassLoader,可以拿到我们的应用加载器。然后使用它进行加载即可。</p>
<p>2、通过使用SPI(Service Provide Interface）来进行打破,可以使用ServiceLoader.loader进行加载。</p>
<h3 id="自定义类加载器"><a href="#自定义类加载器" class="headerlink" title="自定义类加载器"></a>自定义类加载器</h3><p>问问自己,什么时候需要自定义类加载器</p>
<p>1、想加载非classpath、随意路径下中的类文件</p>
<p>2、都是通过接口来进行实现，希望解耦时,常用在框架设计</p>
<p>3、这些类希望予以隔离,不同应用的同名类都可以加载，不冲突，常用于tomact容器</p>
<p>实现步骤:</p>
<ul>
<li>继承ClassLoader父类</li>
<li>要遵从双亲委派机制,重写findClass方法<ul>
<li>注意不是重写loadClass方法,否则不会走双亲委托机制</li>
</ul>
</li>
<li>读取类文件的字节码</li>
<li>调用父类的defineClass方法来加载类</li>
<li>使用者调用该类加载器的loadClass方法</li>
</ul>
<p>示例:</p>
<p>自定义的类加载器:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>kevintam<span class="token punctuation">.</span>load<span class="token punctuation">;</span>


<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span>Files<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span>Paths<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author kevintam
 * @version 1.0
 * @title
 * @description
 * @createDate 2022/8/1
 * 自定义类加载器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">findClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//路径,拿到某个文件的字节码文件</span>
        String path<span class="token operator">=</span><span class="token string">"/Users/kevintam/classpath/"</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">".class"</span><span class="token punctuation">;</span>
        ByteArrayOutputStream os <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//拿到一个输出流</span>
            Files<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//得到字节码文件</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>bytes<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token string">"类文件找不到"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="运行期优化"><a href="#运行期优化" class="headerlink" title="运行期优化"></a>运行期优化</h2><h3 id="即时编译"><a href="#即时编译" class="headerlink" title="即时编译"></a>即时编译</h3><h4 id="分层编译"><a href="#分层编译" class="headerlink" title="分层编译"></a>分层编译</h4><p>先来个例子:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JIT1</span><span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">200</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> start<span class="token operator">=</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> end<span class="token operator">=</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t%d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>出现的结果:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20220801231753811.png" alt="image-20220801231753811"></p>
<p>原因是什么呢？</p>
<p>JVM将执行状态分成了5个层次</p>
<ul>
<li>0层,解释执行</li>
<li>1层，使用c1即时编译器执行(不带profiling)</li>
<li>2层，使用c1即时编译器编译执行(带基本的profiling)</li>
<li>3层,使用c1即时编译器编译执行（带完全的profiling）</li>
<li>4层，使用c2即时编译器编译执行</li>
</ul>
<blockquote>
<p>profiling是指在运行过程中收集一些程序执行状态的数据,例如[方法的调用次数],【循环的回边次数】等</p>
</blockquote>
<p>即时编译器(JIT)与解释器等区别</p>
<ul>
<li>解释器是将字节码解释为机器码,下次即时遇到相同的字节码,仍会执行重复的解释</li>
<li>JIT是将一些字节码编译为机器码,并存入Code Cache，下次遇到相同的代码,直接执行,无需再编译</li>
<li>解释器是将字节码解释为针对所有平台都通用的机器码</li>
<li>JIT会根据平台类型，生成平台特定的机器码</li>
</ul>
<p>对于占据大部分的不常用的代码,我们无需耗费时间将其编译成机器码,而是采取解释执行的方式运行,另一方面，对于仅占据小部分的热点代码,我们则可以将其编译成机器码，以达到理想的运行速度。执行效率上简单比较一下Interpreter&lt;c1&lt;c2,总的目标是发现热点代码(hotspot名称的由来),优化之</p>
<p>刚才的一种优化手段称之为[逃逸分析],发现新建的对象是否逃逸。可以使用-XX:-DoEscapeAnalvsis关闭。</p>
<p>逃逸分析:通过逃逸分析后的对象,可将这些对象直接在栈上进行分配,而非堆上。极大的降低了GC次数,从而提升程序整体的执行效率。</p>
<h4 id="方法内连"><a href="#方法内连" class="headerlink" title="方法内连"></a>方法内连</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> i<span class="token operator">*</span>i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果发现square是热点方法,并且长度不太长时,会进行内联，所谓的内联就是把方法内代码拷贝、粘贴到调用者的位置:</p>
<pre class=" language-java"><code class="language-java">System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>还能够进行重复折叠的优化</p>
<pre class=" language-java"><code class="language-java">System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">kevintam</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2022/04/27/jvm/">http://example.com/2022/04/27/jvm/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">kevintam</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/jvm/">
                                    <span class="chip bg-color">jvm</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2023/03/22/java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                    <div class="card-image">
                        
                        <img src="https://images.pexels.com/photos/417074/pexels-photo-417074.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500" class="responsive-img" alt="单例模式">
                        
                        <span class="card-title">单例模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">
                                    技术
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="chip bg-color">设计模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/12/01/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="代理模式">
                        
                        <span class="card-title">代理模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">
                                    技术
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="chip bg-color">设计模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: kevintam<br />'
            + 'Author: kevintam<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">kevintam</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/txh-rookie" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=843808107" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 843808107" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
