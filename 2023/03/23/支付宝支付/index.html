<!DOCTYPE HTML>
<html lang="zh">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="支付宝支付, kevintam">
    <meta name="description" content="支付接口的调研:微信支付接口调研:一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。
本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。
微信目前提供的支付方式如下：">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>支付宝支付 | kevintam</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">kevintam</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">kevintam</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/txh-rookie" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>txh-rookie
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/txh-rookie" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="txh-rookie" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">支付宝支付</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E9%A1%B9%E7%9B%AE/">
                                <span class="chip bg-color">项目</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">
                                技术
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2023-03-23
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="支付接口的调研"><a href="#支付接口的调研" class="headerlink" title="支付接口的调研:"></a>支付接口的调研:</h2><h3 id="微信支付接口调研"><a href="#微信支付接口调研" class="headerlink" title="微信支付接口调研:"></a>微信支付接口调研:</h3><p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p>
<p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p>
<p>微信目前提供的支付方式如下：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160603449.png" alt="image-20230323160603449"></p>
<ol>
<li><p>付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160633442.png" alt="image-20230323160633442"></p>
</li>
<li><p>SAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p>
<p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p>
<p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160650164.png" alt="image-20230323160650164"></p>
</li>
<li><p>小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160710635.png" alt="image-20230323160710635"></p>
</li>
<li><p>Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160729715.png" alt="image-20230323160729715"></p>
</li>
<li><p>APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160750086.png" alt="image-20230323160750086"></p>
</li>
<li><p>刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p>
</li>
</ol>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160805994.png" alt="image-20230323160805994"></p>
<p>以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？</p>
<p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在H5页面唤起微信客户端完成支付。</p>
<p>本项目选择JSAPI支付接口。</p>
<p>接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p>
<p>如果要微信的话需要开通账号认证。</p>
<h3 id="支付宝接口调研"><a href="#支付宝接口调研" class="headerlink" title="支付宝接口调研:"></a>支付宝接口调研:</h3><p>支付宝支付产品如下：</p>
<p>文档：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323160945145.png" alt="image-20230323160945145"></p>
<p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p>
<p>1、电脑网站支付</p>
<p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p>
<p><img src="https://gw.alipayobjects.com/mdn/rms_e15e15/afts/img/A*bbMhQJxew7wAAAAAAAAAAABjARQnAQ" alt="img"></p>
<p>2、手机网站支付</p>
<p><img src="https://gw.alipayobjects.com/mdn/rms_e15e15/afts/img/A*KhnKRKr3vsEAAAAAAAAAAABjARQnAQ" alt="img"></p>
<p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p>
<p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p>
<p>本项目选择手机网站支付方式。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<h3 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a>准备开发环境</h3><p>第三方支付接口流程大同小异，考虑开发及教学的方便性，支付宝提供支付宝沙箱环境开发支付接口，在教学中接入支付宝手机网站支付接口。</p>
<p>1、配置沙箱环境</p>
<p>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。</p>
<p>接入手机网站支付需要具备如下条件：</p>
<p>•    申请前必须拥有经过实名认证的支付宝账户；</p>
<p>•    企业或个体工商户可申请；</p>
<p>•    需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；</p>
<p>•    网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；</p>
<p>•    网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；</p>
<p>•    如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。</p>
<p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203">https://docs.open.alipay.com/203</a></p>
<p>本文档使用支付宝沙箱进行开发测试，这里主要介绍支付宝沙箱环境配置。</p>
<p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/200/105311/">https://docs.open.alipay.com/200/105311/</a></p>
<h3 id="创建一个订单服务"><a href="#创建一个订单服务" class="headerlink" title="创建一个订单服务"></a>创建一个订单服务</h3><p>创建订单服务过程study-plus-orders到自己的过程目录。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323195840976.png" alt="image-20230323195840976"></p>
<h3 id="支付接口测试"><a href="#支付接口测试" class="headerlink" title="支付接口测试"></a>支付接口测试</h3><p>手机网站支付接入流程详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105285/">https://docs.open.alipay.com/203/105285/</a></p>
<h4 id="1、接口交互流程如下："><a href="#1、接口交互流程如下：" class="headerlink" title="1、接口交互流程如下："></a>1、接口交互流程如下：</h4><p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323203611508.png" alt="image-20230323203611508"></p>
<p>1）用户在商户的H5网站下单支付后，商户系统按照<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</p>
<p>2）前端页面通过Form表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝APP，则自动唤起支付宝APP。</p>
<p>3）输入支付密码完成支付。</p>
<p>4）用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</p>
<p>5）支付宝还会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</p>
<h4 id="2、接口定义"><a href="#2、接口定义" class="headerlink" title="2、接口定义:"></a>2、接口定义:</h4><p>文档:<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>接口定义：外部商户请求支付宝创建订单并支付</p>
<p>公共参数</p>
<p><strong>请求地址</strong>：</p>
<p>开发中使用沙箱地址：<a target="_blank" rel="noopener" href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p>
<p>请求参数：</p>
<p>详细查阅<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<p>一部分由sdk设置，一部分需要编写程序时指定。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323204204833.png" alt="image-20230323204204833"></p>
<p>其它扩展参数参见接口文档。</p>
<h4 id="3、示例代码"><a href="#3、示例代码" class="headerlink" title="3、示例代码"></a>3、示例代码</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span>HttpServletRequest httpRequest<span class="token punctuation">,</span>
                   HttpServletResponse httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
    AlipayClient alipayClient <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">//获得初始化的AlipayClient</span>
    AlipayTradeWapPayRequest alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建API对应的request</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span><span class="token string">"http://domain.com/CallBack/return_url.jsp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token string">"http://domain.com/CallBack/notify_url.jsp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在公共参数中设置回跳和通知地址</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">"{"</span> <span class="token operator">+</span>
            <span class="token string">"    \"out_trade_no\":\"20150320010101002\","</span> <span class="token operator">+</span>
            <span class="token string">"    \"total_amount\":88.88,"</span> <span class="token operator">+</span>
            <span class="token string">"    \"subject\":\"Iphone6 16G\","</span> <span class="token operator">+</span>
            <span class="token string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> <span class="token operator">+</span>
            <span class="token string">"  }"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//填充业务参数</span>
    String form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//调用SDK生成表单</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> AlipayServiceEnvConstants<span class="token punctuation">.</span>CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//直接将完整的表单html输出到页面</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="4、下单执行流程"><a href="#4、下单执行流程" class="headerlink" title="4、下单执行流程"></a>4、<strong>下单执行流程</strong></h4><p>根据接口描述，支付宝下单接口的执行流程如下：</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323204555884.png" alt="image-20230323204555884"></p>
<h4 id="5、支付接口测试"><a href="#5、支付接口测试" class="headerlink" title="5、支付接口测试"></a>5、<strong>支付接口测试</strong></h4><p><strong>编写下单代码</strong></p>
<p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口。</p>
<p>在订单服务api工程添加依赖：</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.7.73.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment" spellcheck="true">&lt;!-- 支付宝SDK依赖的日志 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>下载示例代码<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p>代码Demo编写:请求支付宝，拿起我们的请求页面</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/playTest"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span>HttpServletRequest httpRequest<span class="token punctuation">,</span>
                       HttpServletResponse httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException<span class="token punctuation">,</span> AlipayApiException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * 测试的接口参数为:
         * 1、url请求的地址
         * 2、appid商户id
         * 3、私钥
         * 4、请求格式
         * 5、编码
         * 6、支付宝公钥
         * 7、加密方式
         */</span>
        AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>RSA_PRIVATE_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>FORMAT<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span>AlipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获得初始化的AlipayClient</span>
        AlipayTradeWapPayRequest alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建API对应的request</span>
<span class="token comment" spellcheck="true">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span>
<span class="token comment" spellcheck="true">//        alipayRequest.setNotifyUrl("http://domain.com/CallBack/notify_url.jsp");//在公共参数中设置回跳和通知地址</span>
        <span class="token comment" spellcheck="true">//out_trade_no商户的订单号</span>
<span class="token comment" spellcheck="true">//        total_amount订单的总金额</span>
        <span class="token comment" spellcheck="true">//subject 订单标题。</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">"{"</span> <span class="token operator">+</span>
                <span class="token string">"    \"out_trade_no\":\"20150320010101002\","</span> <span class="token operator">+</span>
                <span class="token string">"    \"total_amount\":88.88,"</span> <span class="token operator">+</span>
                <span class="token string">"    \"subject\":\"Iphone6 16G\","</span> <span class="token operator">+</span>
                <span class="token string">"    \"product_code\":\"QUICK_WAP_WAY\""</span> <span class="token operator">+</span>
                <span class="token string">"  }"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//填充业务参数</span>
        String form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//调用SDK生成表单</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h4 id="生成二维码"><a href="#生成二维码" class="headerlink" title="生成二维码"></a><strong>生成二维码</strong></h4><p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p>
<p>ZXing是一个开源的类库，是用Java编写的多格式的1D &#x2F; 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p>
<p>1）引入依赖</p>
<p>在base工程pom.xml中添加依赖：</p>
<pre class=" language-xml"><code class="language-xml"> <span class="token comment" spellcheck="true">&lt;!-- 二维码生成&amp;识别组件 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.google.zxing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.3.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.google.zxing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>javase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.3.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>2）生成二维码方法。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>kevintam<span class="token punctuation">.</span>study<span class="token punctuation">.</span>utils<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>BarcodeFormat<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>EncodeHintType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>client<span class="token punctuation">.</span>j2se<span class="token punctuation">.</span>MatrixToImageWriter<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>common<span class="token punctuation">.</span>BitMatrix<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>qrcode<span class="token punctuation">.</span>QRCodeWriter<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>zxing<span class="token punctuation">.</span>qrcode<span class="token punctuation">.</span>decoder<span class="token punctuation">.</span>ErrorCorrectionLevel<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span>ImageIO<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span>BufferedImage<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * @author Mr.M
 * @version 1.0
 * @description 二维码生成工具
 * @date 2022/10/3 0:03
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QRCodeUtil</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * 生成二维码
     *
     * @param content 二维码对应的URL
     * @param width   二维码图片宽度
     * @param height  二维码图片高度
     * @return
     */</span>
    <span class="token keyword">public</span> String <span class="token function">createQRCode</span><span class="token punctuation">(</span>String content<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        String resultImage <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//除了尺寸，传入内容不能为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ServletOutputStream stream <span class="token operator">=</span> null<span class="token punctuation">;</span>
            ByteArrayOutputStream os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//二维码参数</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span>
            HashMap<span class="token operator">&lt;</span>EncodeHintType<span class="token punctuation">,</span> Comparable<span class="token operator">></span> hints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//指定字符编码为“utf-8”</span>
            hints<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>EncodeHintType<span class="token punctuation">.</span>CHARACTER_SET<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//L M Q H四个纠错等级从低到高，指定二维码的纠错等级为M</span>
            <span class="token comment" spellcheck="true">//纠错级别越高，可以修正的错误就越多，需要的纠错码的数量也变多，相应的二维吗可储存的数据就会减少</span>
            hints<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>EncodeHintType<span class="token punctuation">.</span>ERROR_CORRECTION<span class="token punctuation">,</span> ErrorCorrectionLevel<span class="token punctuation">.</span>M<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//设置图片的边距</span>
            hints<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>EncodeHintType<span class="token punctuation">.</span>MARGIN<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//zxing生成二维码核心类</span>
                QRCodeWriter writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//把输入文本按照指定规则转成二维吗</span>
                BitMatrix bitMatrix <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> BarcodeFormat<span class="token punctuation">.</span>QR_CODE<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//生成二维码图片流</span>
                BufferedImage bufferedImage <span class="token operator">=</span> MatrixToImageWriter<span class="token punctuation">.</span><span class="token function">toBufferedImage</span><span class="token punctuation">(</span>bitMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//输出流</span>
                ImageIO<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bufferedImage<span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/**
                 * 原生转码前面没有 data:image/png;base64 这些字段，返回给前端是无法被解析，所以加上前缀
                 */</span>
                resultImage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"data:image/png;base64,"</span> <span class="token operator">+</span> EncryptUtil<span class="token punctuation">.</span><span class="token function">encodeBase64</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> resultImage<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"生成二维码出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        QRCodeUtil qrCodeUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrCodeUtil<span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span><span class="token string">"http://localhost:63050/orders/alipaytest"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>运行main方法输入二维码图片的base64串，如下：</p>
<pre class=" language-bash"><code class="language-bash">data:image/png<span class="token punctuation">;</span>base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABXUlEQVR42u2YSY6EMAxFnVWO4ZuS5KY5Rla4PRWgKvWm1VL+oiIkIh4L4+HbgeS3RV/yR7JIVxHpVc46ibjbA8YgrCYOvRYrHL63hxikEwfRL2i2oYJFZls8Yo9HikwL+8Ii4u7UNDwU1fc82EroZWxeb/Wzk7zWWaX7Kx+6s4+4L+8gLzoqDLHY0kF8mskqgZaSbTEG0Tv5slohr2DNRwwSvULvU32ptketQJBoFBZqleTZ3KNHdrPdxI0VT8Nh+9mioWEQU7u7b1DzPQYxDY4gh8m9+ndgkOHJaPJcw6NQJCPsQwr7WwxBPAFLVEmSq352E1flZt3M3KnKd5rGYBBv++UqjhXyLBAklnfals32ruDNJE855s6ycow6q2CQmDpDXTzOUSgY5DrlhFNt5BQkkkdDG/H6YwqAIN7/42gYGgNCnk0jquSZiVtJnnK6aV4oX3az/eT7v+p/yQ/ovSDjCl7mQgAAAABJRU5ErkJggg<span class="token operator">==</span>
</code></pre>
<h4 id="支付结果查询接口"><a href="#支付结果查询接口" class="headerlink" title="支付结果查询接口"></a><strong>支付结果查询接口</strong></h4><p>支付完成可以调用第三方支付平台的支付结果查询接口 查询支付结果。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p>
<p>示例代码:</p>
<pre class=" language-java"><code class="language-java">AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token string">"https://openapi.alipay.com/gateway.do"</span><span class="token punctuation">,</span><span class="token string">"app_id"</span><span class="token punctuation">,</span><span class="token string">"your private_key"</span><span class="token punctuation">,</span><span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">"GBK"</span><span class="token punctuation">,</span><span class="token string">"alipay_public_key"</span><span class="token punctuation">,</span><span class="token string">"RSA2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AlipayTradeQueryRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
JSONObject bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> <span class="token string">"20150320010101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//bizContent.put("trade_no", "2014112611001004680073956707");</span>
request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AlipayTradeQueryResponse response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p>
<p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p>
<p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p>
<p>我们使用out_trade_no商品订单号去查询，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"getOrder"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> AlipayApiException <span class="token punctuation">{</span>
        AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>RSA_PRIVATE_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>FORMAT<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span>AlipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AlipayTradeQueryRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONObject bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> <span class="token string">"20150320010101002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//bizContent.put("trade_no", "2014112611001004680073956707");</span>
        request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AlipayTradeQueryResponse response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>响应如下:</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"alipay_trade_query_response"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"code"</span><span class="token operator">:</span><span class="token string">"10000"</span><span class="token punctuation">,</span>
                                <span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"Success"</span><span class="token punctuation">,</span>
                                <span class="token property">"buyer_logon_id"</span><span class="token operator">:</span><span class="token string">"drf***@sandbox.com"</span><span class="token punctuation">,</span>
                                <span class="token property">"buyer_pay_amount"</span><span class="token operator">:</span><span class="token string">"0.00"</span><span class="token punctuation">,</span>
                                <span class="token property">"buyer_user_id"</span><span class="token operator">:</span><span class="token string">"2088102180608143"</span><span class="token punctuation">,</span>
                                <span class="token property">"buyer_user_type"</span><span class="token operator">:</span><span class="token string">"PRIVATE"</span><span class="token punctuation">,</span>
                                <span class="token property">"invoice_amount"</span><span class="token operator">:</span><span class="token string">"0.00"</span><span class="token punctuation">,</span>
                                <span class="token property">"out_trade_no"</span><span class="token operator">:</span><span class="token string">"20150320010101002"</span><span class="token punctuation">,</span>
                                <span class="token property">"point_amount"</span><span class="token operator">:</span><span class="token string">"0.00"</span><span class="token punctuation">,</span>
                                <span class="token property">"receipt_amount"</span><span class="token operator">:</span><span class="token string">"0.00"</span><span class="token punctuation">,</span>
                                <span class="token property">"send_pay_date"</span><span class="token operator">:</span><span class="token string">"2023-03-23 21:43:38"</span><span class="token punctuation">,</span>
                                <span class="token property">"total_amount"</span><span class="token operator">:</span><span class="token string">"88.88"</span><span class="token punctuation">,</span>
                                <span class="token property">"trade_no"</span><span class="token operator">:</span><span class="token string">"2023032322001408140511381202"</span><span class="token punctuation">,</span>
                                <span class="token property">"trade_status"</span><span class="token operator">:</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token property">"sign"</span><span class="token operator">:</span><span class="token string">"doZWWCAMJsxnOc12zHXFLCf2JrjgTjk7Qi2PnHld7EWDQZvhbUbR+3utVlX/S1G0Dh/SAWkNKd518xzQ+I3+LsGy4pF+BLR0vJzFUzZ8Ou13gjwxcjCBmUWBxdudRbTbtLaugZdBjPpxIn7+APuQYdIPuB/NLepUNqamkK4Zb+m7djtv81u13xlXjnFL/kXSUe2DEDtSlJj4LoZHiE6UrCph+Sqs70pD0vjbXP777NhqcugtK7hbpFhTpWfCCFDdL37nPS67ArwLpwo0HiGdbGyBiPYPKG1wkoJd7HmBI8xdZ6vF1LqNeXK5DWwp1STlX2+YWbPEBX37lBwmY9Ha4w=="</span><span class="token punctuation">}</span>
</code></pre>
<p>参考文档<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a> 查阅每个参数的意义。</p>
<p>我们主要需要下边的参数：</p>
<p>“out_trade_no” : “20220520010101026”,</p>
<p>“trade_no”:”2022100422001422760505740639” ： 支付宝交易流水号</p>
<p>“total_amount” : “1.30”</p>
<p>“trade_status” : “TRADE_SUCCESS”： 交易状态</p>
<p>交易状态类型：</p>
<p>交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）</p>
<p>TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</p>
<p>TRADE_SUCCESS（交易支付成功）</p>
<p>TRADE_FINISHED（交易结束，不可退款）</p>
<h4 id="支付结果通知接口"><a href="#支付结果通知接口" class="headerlink" title="支付结果通知接口"></a><strong>支付结果通知接口</strong></h4><p>对于手机网站支付产生的交易，支付宝会根据原始支付 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。详情可查看 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a> 。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p>
<p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p>
<ol>
<li><p>在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</p>
</li>
<li><p>将签名参数（sign）使用 base64 解码为字节码串；</p>
</li>
<li><p>使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</p>
</li>
<li><p>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</p>
</li>
</ol>
<p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p>
<p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p>
<p>验证的过程可以参考sdk demo代码，下载 sdk demo代码，<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p>
<p><strong>编写测试代码</strong></p>
<p>1、在下单请求时设置通知地址request.setNotifyUrl(“商户自己的notify_url地址”);</p>
<pre class=" language-java"><code class="language-java"><span class="token function">PostMapping</span><span class="token punctuation">(</span><span class="token string">"/paynotify"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paynotify</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> UnsupportedEncodingException<span class="token punctuation">,</span> AlipayApiException <span class="token punctuation">{</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Map requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span>
        <span class="token comment" spellcheck="true">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//商户订单号</span>

    String out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//支付宝交易号</span>

    String trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//交易状态</span>
    String trade_status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span>
    <span class="token comment" spellcheck="true">//计算得出通知验证结果</span>
    <span class="token comment" spellcheck="true">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String> params, String publicKey, String charset, String sign_type)</span>
    <span class="token keyword">boolean</span> verify_result <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> CHARSET<span class="token punctuation">,</span> <span class="token string">"RSA2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verify_result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//验证成功</span>
        <span class="token comment" spellcheck="true">//////////////////////////////////////////////////////////////////////////////////////////</span>
        <span class="token comment" spellcheck="true">//请在这里加上商户的业务逻辑程序代码</span>

        <span class="token comment" spellcheck="true">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_FINISHED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//交易结束</span>
            <span class="token comment" spellcheck="true">//判断该笔订单是否在商户网站中已经做过处理</span>
            <span class="token comment" spellcheck="true">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span>
            <span class="token comment" spellcheck="true">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span>
            <span class="token comment" spellcheck="true">//如果有做过处理，不执行商户的业务程序</span>

            <span class="token comment" spellcheck="true">//注意：</span>
            <span class="token comment" spellcheck="true">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span>
            <span class="token comment" spellcheck="true">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//交易成功</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//判断该笔订单是否在商户网站中已经做过处理</span>
            <span class="token comment" spellcheck="true">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span>
            <span class="token comment" spellcheck="true">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span>
            <span class="token comment" spellcheck="true">//如果有做过处理，不执行商户的业务程序</span>

            <span class="token comment" spellcheck="true">//注意：</span>
            <span class="token comment" spellcheck="true">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre>
<h4 id="通知接口测试"><a href="#通知接口测试" class="headerlink" title="通知接口测试"></a><strong>通知接口测试</strong></h4><p>1、重启订单服务，并在下单接口中打上断点</p>
<p>2、配置内网穿透的本地端口为订单服务端口，启动内网穿透客户端。</p>
<p>3、打开模拟器、支付宝沙箱，扫码、支付。</p>
<p>4、观察下单接口断点处的执行情况、接收数据等是否正常。</p>
<h3 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战:"></a>项目实战:</h3><p>点击“支付宝支付”此时打开支付二维码，用户扫码支付。</p>
<p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p>
<p>生成二维码执行流程如下：</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323223103719.png" alt="image-20230323223103719"></p>
<p>执行流程：</p>
<p>1、前端调用学习中心服务的添加选课接口。</p>
<p>2、添加选课成功请求订单服务生成支付二维码接口。</p>
<p>3、生成二维码接口：创建商品订单、生成支付交易记录、生成二维码。</p>
<p>4、将二维码返回到前端，用户扫码。</p>
<p>用户扫码支付流程如下：</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323230516623.png" alt="image-20230323230516623"></p>
<h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323230553795.png" alt="image-20230323230553795"></p>
<p>订单表：记录订单信息</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230323230610490.png" alt="image-20230323230610490"></p>
<p>订单明细表记录订单的详细信息：</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230324184737807.png" alt="image-20230324184737807"></p>
<p>支付交易记录表记录与支付平台的交易明细:</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230324184816694.png" alt="image-20230324184816694"></p>
<p>三张表之间的关系就是订单表和订单明细表是一对多的关系。然后我们的订单记录表和订单表也是一对多的关系。</p>
<p>因为我们发起支付宝的请求页面需要将我们的订单信息发送给我们的支付宝页面，如果是将我们的订单id发送过去的话，有可能会造成支付中断，导致再次将订单id发送过去，有可能会导致该订单Id支付不成功，因为你发送过一次支付了，再次支付有可能会出现一些问题。所以一般我们是将订单记录发送过去。</p>
<p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p>
<p>1、时间戳+随机数</p>
<p>年月日时分秒毫秒+随机数</p>
<p>2、高并发场景</p>
<p>年月日时分秒毫秒+随机数+redis自增序列</p>
<p>3、订单号中加上业务标识</p>
<p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p>
<p>4、雪花算法</p>
<p>雪花算法是推特内部使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p>
<p>1位的符号位、32位的时间戳、12位的机器码</p>
<p>本项目订单号生成采用雪花算法。</p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h4><p>在订单服务中定义生成支付二维码接口。</p>
<p>请求：订单信息</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddOrderDto</span>  <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 总价
     */</span>
    <span class="token keyword">private</span> Float totalPrice<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 订单类型
     */</span>
    <span class="token keyword">private</span> String orderType<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 订单名称
     */</span>
    <span class="token keyword">private</span> String orderName<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 订单描述
     */</span>
    <span class="token keyword">private</span> String orderDescrip<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 订单明细json，不可为空
     * [{"goodsId":"","goodsType":"","goodsName":"","goodsPrice":"","goodsDetail":""},{...}]
     */</span>
    <span class="token keyword">private</span> String orderDetail<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 外部系统业务id
     */</span>
    <span class="token keyword">private</span> String outBusinessId<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>响应：支付交易记录信息及二维码信息：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayRecordDto</span> <span class="token keyword">extends</span> <span class="token class-name">XcPayRecord</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//二维码</span>
    <span class="token keyword">private</span> String qrcode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接口定义如下：</p>
<p>AddOrderDTO就是一个下单的信息，前端点击下单操作，会将用户的信息发送到我们的后端中，我们将信息，做一个幂等姓的校验。</p>
<p>用户扫码请求下单，定义下单接口如下：</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"根据用户下单生成一个二维码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> PayRecordDto <span class="token function">payRecordDto</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> AddOrderDto addOrderDto<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>用户扫码请求下单，定义下单接口如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"扫码下单接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/requestpay"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestpay</span><span class="token punctuation">(</span>String payNo<span class="token punctuation">,</span>HttpServletResponse httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre>
<h4 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a><strong>接口实现</strong></h4><p><strong>保存商品订单</strong></p>
<p>商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</p>
<p>定义保存订单信息接口</p>
<pre class=" language-java"><code class="language-java">
   <span class="token comment" spellcheck="true">/**
 * @description 创建商品订单
 * @param addOrderDto 订单信息
 * @return PayRecordDto 支付交易记录(包括二维码)
 * @author Mr.M
 * @date 2022/10/4 11:02
*/</span>
<span class="token keyword">public</span> PayRecordDto <span class="token function">createOrder</span><span class="token punctuation">(</span>String userId<span class="token punctuation">,</span>AddOrderDto addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>在保存订单接口中需要做创建商品订单、创建支付交易记录</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> PayRecordDto <span class="token function">createOrder</span><span class="token punctuation">(</span>String userId<span class="token punctuation">,</span>AddOrderDto addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//添加商品订单</span>

    <span class="token comment" spellcheck="true">//添加支付交易记录</span>

<span class="token punctuation">}</span>
</code></pre>
<p>编写创建商品订单方法：</p>
<pre class=" language-java"><code class="language-java">Transactional
<span class="token keyword">public</span> XcOrders <span class="token function">saveXcOrders</span><span class="token punctuation">(</span>String userId<span class="token punctuation">,</span>AddOrderDto addOrderDto<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//幂等性处理</span>
    XcOrders order <span class="token operator">=</span> <span class="token function">getOrderByBusinessId</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOutBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//生成订单号</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> IdWorkerUtils<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"600001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//未支付</span>
    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderType</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderName</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderDetail</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderDescrip</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDescrip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOutBusinessId</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOutBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//选课记录id</span>
    ordersMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String orderDetailJson <span class="token operator">=</span> addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>XcOrdersGoods<span class="token operator">></span> xcOrdersGoodsList <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>orderDetailJson<span class="token punctuation">,</span> XcOrdersGoods<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcOrdersGoodsList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>goods<span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>
        XcOrdersGoods xcOrdersGoods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrdersGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>goods<span class="token punctuation">,</span>xcOrdersGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcOrdersGoods<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//订单号</span>
        ordersGoodsMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcOrdersGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//根据业务id查询订单</span>
<span class="token keyword">public</span> XcOrders <span class="token function">getOrderByBusinessId</span><span class="token punctuation">(</span>String businessId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    XcOrders orders <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token operator">&lt;</span>XcOrders<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>XcOrders<span class="token operator">:</span><span class="token operator">:</span>getOutBusinessId<span class="token punctuation">,</span> businessId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="创建支付交易记录"><a href="#创建支付交易记录" class="headerlink" title="创建支付交易记录"></a><strong>创建支付交易记录</strong></h4><p><strong><font color="red">为什么创建支付交易记录？</font></strong></p>
<p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p>
<p>解决以上问题的方案是：</p>
<p>1、用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p>
<p>2、将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p>
<p>3、需要提醒用户不要重复支付。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230324190926958.png" alt="image-20230324190926958"></p>
<p>编写创建支付交易记录的方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> XcPayRecord <span class="token function">createPayRecord</span><span class="token punctuation">(</span>XcOrders orders<span class="token punctuation">)</span><span class="token punctuation">{</span>

    XcPayRecord payRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcPayRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//生成支付交易流水号</span>
    <span class="token keyword">long</span> payNo <span class="token operator">=</span> IdWorkerUtils<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setPayNo</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//商品订单号</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setOrderName</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setCurrency</span><span class="token punctuation">(</span><span class="token string">"CNY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"601001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//未支付</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecordMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>生成支付二维码</strong></p>
<p>完善创建订单service方法</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> PayRecordDto <span class="token function">createOrder</span><span class="token punctuation">(</span>String userId<span class="token punctuation">,</span> AddOrderDto addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//创建商品订单</span>
    XcOrders orders <span class="token operator">=</span> <span class="token function">saveXcOrders</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//生成支付记录</span>
    XcPayRecord payRecord <span class="token operator">=</span> <span class="token function">createPayRecord</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//生成二维码</span>
    String qrCode <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//url要可以被模拟器访问到，url为下单接口(稍后定义)</span>
        qrCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span><span class="token string">"http://192.168.101.1/api/orders/requestpay?payNo="</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getPayNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        XueChengPlusException<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"生成二维码出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    PayRecordDto payRecordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayRecordDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">,</span>payRecordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecordDto<span class="token punctuation">.</span><span class="token function">setQrcode</span><span class="token punctuation">(</span>qrCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> payRecordDto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="生成二维码接口完善"><a href="#生成二维码接口完善" class="headerlink" title="生成二维码接口完善"></a><strong>生成二维码接口完善</strong></h4><p>完善生成支付二维码controller接口</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"生成支付二维码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/generatepaycode"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> PayRecordDto <span class="token function">generatePayCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> AddOrderDto addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//登录用户</span>
    SecurityUtil<span class="token punctuation">.</span>XcUser user <span class="token operator">=</span> SecurityUtil<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        XueChengPlusException<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"请登录后继续选课"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">return</span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
<span class="token punctuation">}</span>
</code></pre>
<p><strong>扫码下单接口</strong></p>
<p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p>
<p>1、定义查询支付交易记录的Service接口与实现方法</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * @description 查询支付交易记录
 * @param payNo  交易记录号
 * @return com.xuecheng.orders.model.po.XcPayRecord
 * @author Mr.M
 * @date 2022/10/20 23:38
*/</span>
<span class="token keyword">public</span> XcPayRecord <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>String payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>实现如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> XcPayRecord <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>String payNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    XcPayRecord xcPayRecord <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token operator">&lt;</span>XcPayRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>XcPayRecord<span class="token operator">:</span><span class="token operator">:</span>getPayNo<span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcPayRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>定义下单接口如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"扫码下单接口"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/requestpay"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestpay</span><span class="token punctuation">(</span>String payNo<span class="token punctuation">,</span>HttpServletResponse httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果payNo不存在则提示重新发起支付</span>
        XcPayRecord payRecord <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>payRecord <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            XueChengPlusException<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"请重新点击支付获取二维码"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//构造sdk的客户端对象</span>
        AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>serverUrl<span class="token punctuation">,</span> APP_ID<span class="token punctuation">,</span> APP_PRIVATE_KEY<span class="token punctuation">,</span> <span class="token string">"json"</span><span class="token punctuation">,</span> CHARSET<span class="token punctuation">,</span> ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> sign_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获得初始化的AlipayClient</span>
        AlipayTradeWapPayRequest alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建API对应的request</span>
<span class="token comment" spellcheck="true">//        alipayRequest.setReturnUrl("http://domain.com/CallBack/return_url.jsp");</span>
<span class="token comment" spellcheck="true">//        alipayRequest.setNotifyUrl("http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify");//在公共参数中设置回跳和通知地址</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">"{"</span> <span class="token operator">+</span>
                <span class="token string">" \"out_trade_no\":\""</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getPayNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\","</span> <span class="token operator">+</span>
                <span class="token string">" \"total_amount\":\""</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\","</span> <span class="token operator">+</span>
                <span class="token string">" \"subject\":\""</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\","</span> <span class="token operator">+</span>
                <span class="token string">" \"product_code\":\"QUICK_WAP_PAY\""</span> <span class="token operator">+</span>
                <span class="token string">" }"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//填充业务参数</span>
        String form <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//请求支付宝下单接口,发起http请求</span>
            form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//调用SDK生成表单</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong>接口测试</strong></p>
<p>测试准备：</p>
<p>1、启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p>
<p>2、发布一门收费课程。</p>
<p>测试流程：</p>
<p>1、进入收费课程详细页面，点击马上学习。</p>
<p>2、跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p>
<p>3、观察生成二维码是否成功</p>
<p>4、使用模拟器扫码测试，是否可以正常支付。</p>
<p>如果报订单参数异常报如下错误，需要检查请求支付宝的下单数据是否正确。</p>
<h4 id="对账操作"><a href="#对账操作" class="headerlink" title="对账操作"></a>对账操作</h4><p>上面模拟完成了返回一个二维码到前端，用户通过扫描二维码能跳转到对应的支付页面，进行支付。支付完成之后，我们的后端需要对我们的支付结果，进行查询，虽然支付宝会将支付完成之后会通过回调函数，来调用传递给我们的支付结果，但是呢，为了做保险操作，需要我们的服务器本地的进行查账的操作。</p>
<p>查找的接口:</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/playResult"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"查询支付宝结果的接口"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> PayRecordDto <span class="token function">payRecordDto</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"payNo"</span><span class="token punctuation">)</span> String payNo<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">//1、从数据库中查询数据，进行对账操作，然后去更新我们的数据库</span>
        PayRecordDto recordDto<span class="token operator">=</span>orderService<span class="token punctuation">.</span><span class="token function">getPayResult</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>业务的流程就是:</p>
<p>将我们的订单号传递到后端，后端去支付宝服务器进行请求，请求发送之后，收到我们的结果，然后将结果封装会数据库中。</p>
<p>service的服务器:</p>
<pre class=" language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> PayRecordDto <span class="token function">getPayResult</span><span class="token punctuation">(</span>String payNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StudyException</span><span class="token punctuation">(</span><span class="token string">"订单号不能为null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        XcPayRecord payRecord <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token operator">&lt;</span>XcPayRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"pay_no"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payRecord <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StudyException</span><span class="token punctuation">(</span><span class="token string">"该订单记录号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//查询数据库进行封装操作</span>
        PayStatusDto payStatusDto <span class="token operator">=</span> <span class="token function">getAlipayResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//封装成功</span>
        <span class="token comment" spellcheck="true">//修改数据库中的支付状态位</span>
        <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        XcPayRecord record <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token operator">&lt;</span>XcPayRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"pay_no"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PayRecordDto recordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayRecordDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span>recordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> recordDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>封装数据库:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PayStatusDto <span class="token function">getAlipayResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>RSA_PRIVATE_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>FORMAT<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span>
                AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AlipayTradeQueryRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONObject bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> <span class="token string">"20150320010101002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//bizContent.put("trade_no", "2014112611001004680073956707");</span>
        request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AlipayTradeQueryResponse response <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Map parseMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Map alipay_trade_query_response<span class="token operator">=</span>null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StudyException</span><span class="token punctuation">(</span><span class="token string">"请求支付宝查询支付结果失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            String body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parseMap <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            alipay_trade_query_response<span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">)</span> parseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"alipay_trade_query_response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"请求支付宝支付失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        PayStatusDto payStatusDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayStatusDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payStatusDto<span class="token punctuation">.</span><span class="token function">setApp_id</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_status</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payStatusDto<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payStatusDto<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_no</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> payStatusDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>修改数据库中的支付状态位：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span>PayStatusDto payStatusDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//支付结果</span>
        String trade_status <span class="token operator">=</span> payStatusDto<span class="token punctuation">.</span><span class="token function">getTrade_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//支付流水号</span>
            String payNo <span class="token operator">=</span> payStatusDto<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//查询支付流水</span>
            XcPayRecord payRecord <span class="token operator">=</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//支付金额变为分</span>
            Float totalPrice <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
            Float total_amount <span class="token operator">=</span> Float<span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">.</span><span class="token function">getTotal_amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//校验是否一致</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payRecord <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> payStatusDto<span class="token punctuation">.</span><span class="token function">getApp_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>APP_ID<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> totalPrice<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> total_amount<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String status <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"601001"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//未支付时进行处理</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"更新支付结果,支付交易流水号:{},支付结果:{}"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    XcPayRecord payRecord_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcPayRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    payRecord_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"601002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//支付成功</span>
                    payRecord_u<span class="token punctuation">.</span><span class="token function">setOutPayChannel</span><span class="token punctuation">(</span><span class="token string">"Alipay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    payRecord_u<span class="token punctuation">.</span><span class="token function">setOutPayNo</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">.</span><span class="token function">getTrade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//支付宝交易号</span>
                    payRecord_u<span class="token punctuation">.</span><span class="token function">setPaySuccessTime</span><span class="token punctuation">(</span>LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//通知时间</span>
                    <span class="token keyword">int</span> update1 <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>payRecord_u<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token operator">&lt;</span>XcPayRecord<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>XcPayRecord<span class="token operator">:</span><span class="token operator">:</span>getPayNo<span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>update1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"收到支付通知，更新支付交易状态成功.付交易流水号:{},支付结果:{}"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"收到支付通知，更新支付交易状态失败.支付交易流水号:{},支付结果:{}"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">//关联的订单号</span>
                    Long orderId <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    XcOrders orders <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        XcOrders order_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        order_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"600002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> update <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order_u<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token operator">&lt;</span>XcOrders<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>XcOrders<span class="token operator">:</span><span class="token operator">:</span>getId<span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>update <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"收到支付通知，更新订单状态成功.付交易流水号:{},支付结果:{},订单号:{},状态:{}"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> <span class="token string">"600002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"收到支付通知，更新订单状态失败.支付交易流水号:{},支付结果:{},订单号:{},状态:{}"</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> <span class="token string">"600002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"收到支付通知，根据交易记录找不到订单,交易记录号:{},订单号:{}"</span><span class="token punctuation">,</span> payRecord_u<span class="token punctuation">.</span><span class="token function">getPayNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
</code></pre>
<h4 id="支付结果的通知"><a href="#支付结果的通知" class="headerlink" title="支付结果的通知"></a>支付结果的通知</h4><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/playNotify"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"支付结果的回调地址"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">playNotify</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> AlipayApiException<span class="token punctuation">,</span> UnsupportedEncodingException <span class="token punctuation">{</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                        <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span>
            <span class="token comment" spellcheck="true">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "gbk");</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//商户订单号</span>
        String out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//支付宝交易号</span>
        String trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//交易状态</span>
        String trade_status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String total_amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span>
        <span class="token comment" spellcheck="true">//计算得出通知验证结果</span>
        <span class="token comment" spellcheck="true">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String> params, String publicKey, String charset, String sign_type)</span>
        <span class="token keyword">boolean</span> verify_result <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span> <span class="token string">"RSA2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>verify_result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//验证成功</span>
            <span class="token comment" spellcheck="true">//////////////////////////////////////////////////////////////////////////////////////////</span>
            <span class="token comment" spellcheck="true">//请在这里加上商户的业务逻辑程序代码</span>
            <span class="token comment" spellcheck="true">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//交易成功</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//判断该笔订单是否在商户网站中已经做过处理</span>
                <span class="token comment" spellcheck="true">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span>
                <span class="token comment" spellcheck="true">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span>
                <span class="token comment" spellcheck="true">//如果有做过处理，不执行商户的业务程序</span>
                <span class="token comment" spellcheck="true">//执行我们的保存我们的订单操作即可。</span>
                PayStatusDto recordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayStatusDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordDto<span class="token punctuation">.</span><span class="token function">setTrade_no</span><span class="token punctuation">(</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordDto<span class="token punctuation">.</span><span class="token function">setApp_id</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordDto<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordDto<span class="token punctuation">.</span><span class="token function">setTrade_status</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordDto<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderService<span class="token punctuation">.</span><span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span>recordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h4 id="支付通知"><a href="#支付通知" class="headerlink" title="支付通知"></a>支付通知</h4><p><strong>消息通知方式</strong></p>
<p>订单服务作为通用服务在订单支付成功后需要将支付结果通知给与订单服务对接的其它微服务。</p>
<p>为了保证通知过程的简便还要保证消息全部到达消费服务，采用发布订阅的方式通知支付结果。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230326232046372.png" alt="image-20230326232046372"></p>
<p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p>
<p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p>
<p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果，根据支付结果的内容去更新自己的业务数据。</p>
<p>学习中心等微服务收到消息并处理完成通过消息队列回复订单服务。</p>
<h4 id="分布式事务问题"><a href="#分布式事务问题" class="headerlink" title="分布式事务问题"></a><strong>分布式事务问题</strong></h4><p>订单服务收到第三方支付系统的通知更新支付结果，订单服务将支付结果通知给其它微服务，订单服务需要保证更新支付结果成功并且向其它微服务通知支付结果也成功，两件事跨多个微服务并且需要保证一致性，存在分布式事务控制的需求。</p>
<p>针对该业务场景如何控制分布式事务？</p>
<p>根据需求可知，订单服务先将支付结果更新成功后再将支付结果通知给其它微服务，只要保证最终将支付结果通知到微服务保证最终一致性即可，可以采用课程发布模块的技术方案，先通过本地事务更新支付结果的同时添加一条消息表记录，再由任务调度去定时调度将支付结果通知给其它微服务。</p>
<p><img src="https://blog-1300811828.cos.ap-shanghai.myqcloud.com/uPic/image-20230326232254925.png" alt="image-20230326232254925"></p>
<h4 id="集成消息队列"><a href="#集成消息队列" class="headerlink" title="集成消息队列"></a><strong>集成消息队列</strong></h4><p><strong>支付结果通知队列</strong></p>
<p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p>
<p>1、订单服务创建支付结果通知交换机。</p>
<p>2、学习中心服务绑定队列到交换机。</p>
<p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p>
<p>执行docker start rabbitmq 启动RabbitMQ。访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a> </p>
<p>账户密码：guest&#x2F;guest</p>
<p>交换机Fanout广播模式。</p>
<p>首先需要在内容管理服务层工程和消息服务工程配置连接消息队列。</p>
<p>1、首先在订单服务添加消息队列依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>2、在nacos配置rabbitmq-dev.yaml为通用配置文件</p>
<pre class=" language-yaml"><code class="language-yaml">YAML
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.101.65
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated <span class="token comment" spellcheck="true">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span>
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">false </span><span class="token comment" spellcheck="true">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span>
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">mandatory</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> none <span class="token comment" spellcheck="true">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true">#开启消费者失败重试</span>
          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 1000ms <span class="token comment" spellcheck="true">#初识的失败等待时长为1秒</span>
          <span class="token key atrule">multiplier</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span>
          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3 </span><span class="token comment" spellcheck="true">#最大重试次数</span>
          <span class="token key atrule">stateless</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment" spellcheck="true">#true无状态；false有状态。如果业务中包含事务，这里改为false</span>
</code></pre>
<p>3、编写MQ配置类，配置交换机</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * @description 消息队列配置
 * @author Mr.M
 * @date 2022/10/4 22:25
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayNotifyConfig</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">//交换机</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PAYNOTIFY_EXCHANGE_FANOUT <span class="token operator">=</span> <span class="token string">"paynotify_exchange_fanout"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//支付结果通知消息类型</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String MESSAGE_TYPE <span class="token operator">=</span> <span class="token string">"payresult_notify"</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//声明交换机</span>
  <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>PAYNOTIFY_EXCHANGE_FANOUT<span class="token punctuation">)</span>
  <span class="token keyword">public</span> FanoutExchange <span class="token function">paynotify_exchange_fanout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span>PAYNOTIFY_EXCHANGE_FANOUT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="注意⚠️-跳转和重定向"><a href="#注意⚠️-跳转和重定向" class="headerlink" title="注意⚠️:跳转和重定向"></a>注意⚠️:跳转和重定向</h3><p>跳转的时候实际上是通过我们服务器端将请求转发到另外的页面或者servelt中，这个时候跳转到的目标页面或者servlet可以获取到请求对象，也可以获取到请求中的属性和参数。而外部跳转的时候实际上是第一次请求后，服务器端向我们的客户端再次发送了一个请求，这个时候服务器第二次拿到的request对象已经不是第一次请求的request对象了，所以无法获取到第一次请求里的参数和属性。</p>
<p>跳转的URL地址栏不会发生变化，重定向url则会发生变化。</p>
<p>跳转无法跳转到过程以外的jsp或者servlet，重定向可以。</p>
<h3 id="注意⚠️-long返回给前端精度丢失"><a href="#注意⚠️-long返回给前端精度丢失" class="headerlink" title="注意⚠️:long返回给前端精度丢失"></a>注意⚠️:long返回给前端精度丢失</h3><blockquote>
<p>java服务端如果直接返回Long整数数据给前端，JS会自动转换为Number类型精度浮点数，表示原理和取值范围等同于java的double。Long类型能表示的最大值是2的63次方-1，在取值范围之内，超过2的53次方的数值转换为js的NUmber时，有些数值会有精度损失。</p>
</blockquote>
<p>解决方案:</p>
<p>1、直接将Long id改为String id，这种只适合于这个对象只在这个方法中使用了，比较局限。</p>
<p>2、在属性上标注一个Jackson注解。可以添加@JsonFormat(shape&#x3D;JsonFormat.shape.STRING)或者@JsonSerialize(using&#x3D;ToStringSerializer.class)注解。</p>
<p>但是我们的第二种方式，存在一个问题，就是每一个我们的主键id都需要标注这个注解。我们可以在配置中进行配置。让我们的所有的id都可以采用这中序列化。</p>
<p>Jackson提供了这种支持，可以对ObjectMapper进行定制，具体的代码如下所示:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>

    <span class="token keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="token function">jackson2ObjectMapperBuilderCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> jacksonObjectMapperBuilder <span class="token operator">-</span><span class="token operator">></span> jacksonObjectMapperBuilder

                <span class="token punctuation">.</span><span class="token function">serializerByType</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">serializerByType</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> ToStringSerializer<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">kevintam</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2023/03/23/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98/">http://example.com/2023/03/23/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">kevintam</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E9%A1%B9%E7%9B%AE/">
                                    <span class="chip bg-color">项目</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2023/03/28/%E9%9D%A2%E8%AF%95%E4%BD%93%E6%80%BB%E7%BB%93/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="面试体总结">
                        
                        <span class="card-title">面试体总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            kevintam
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/03/22/java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                    <div class="card-image">
                        
                        <img src="https://images.pexels.com/photos/417074/pexels-photo-417074.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500" class="responsive-img" alt="单例模式">
                        
                        <span class="card-title">单例模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-03-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">
                                    技术
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="chip bg-color">设计模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: kevintam<br />'
            + 'Author: kevintam<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">kevintam</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/txh-rookie" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=843808107" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 843808107" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
